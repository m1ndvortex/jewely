{% extends "base.html" %}

{% block title %}Point of Sale - Jewelry Shop{% endblock %}

{% block content %}
<div x-data="posApp()" x-init="init()" class="h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">
                <i class="fas fa-cash-register mr-2"></i>
                Point of Sale
            </h1>
            <div class="flex items-center space-x-4">
                <!-- Connection Status Indicator -->
                <div class="flex items-center space-x-2">
                    <div 
                        :class="isOnline ? 'bg-green-500' : 'bg-red-500'"
                        class="w-3 h-3 rounded-full"
                        :title="isOnline ? 'Online' : 'Offline'"
                    ></div>
                    <span class="text-xs" x-text="isOnline ? 'Online' : 'Offline'"></span>
                    <span 
                        x-show="pendingTransactions > 0" 
                        class="bg-yellow-500 text-xs px-2 py-1 rounded"
                        :title="`${pendingTransactions} transaction(s) pending sync`"
                        x-text="`${pendingTransactions} pending`"
                    ></span>
                </div>
                
                <div class="text-sm">
                    <i class="fas fa-user mr-1"></i>
                    <span>{{ user.get_full_name }}</span>
                </div>
                <div class="text-sm">
                    <i class="fas fa-store mr-1"></i>
                    <span x-text="selectedTerminal ? selectedTerminal.terminal_id : 'Select Terminal'"></span>
                </div>
                
                <!-- Manual Sync Button (only show when offline transactions exist) -->
                <button 
                    x-show="isOnline && pendingTransactions > 0"
                    @click="manualSync()"
                    class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded text-sm"
                    title="Sync pending transactions"
                >
                    <i class="fas fa-sync-alt mr-1"></i>
                    Sync
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Panel: Product Search -->
        <div class="w-1/2 bg-white border-r border-gray-300 flex flex-col">
            <!-- Search Bar -->
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input 
                        type="text" 
                        x-model="searchQuery"
                        @input.debounce.300ms="searchProducts()"
                        @keydown.enter="searchProducts()"
                        placeholder="Search by SKU, name, or scan barcode..."
                        class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        autofocus
                    >
                    <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                </div>
            </div>


            <!-- Quick Access Tabs -->
            <div x-show="!searchQuery" class="border-b border-gray-200">
                <div class="flex space-x-1 p-2">
                    <button 
                        @click="activeTab = 'favorites'"
                        :class="activeTab === 'favorites' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700'"
                        class="px-3 py-2 rounded text-sm font-medium"
                    >
                        <i class="fas fa-star mr-1"></i>
                        Favorites
                    </button>
                    <button 
                        @click="activeTab = 'recent'"
                        :class="activeTab === 'recent' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700'"
                        class="px-3 py-2 rounded text-sm font-medium"
                    >
                        <i class="fas fa-clock mr-1"></i>
                        Recent
                    </button>
                </div>
            </div>

            <!-- Product Results -->
            <div class="flex-1 overflow-y-auto p-4">
                <div x-show="loading" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i>
                    <p class="mt-2 text-gray-600">Searching...</p>
                </div>

                <div x-show="!loading && searchResults.length === 0 && searchQuery" class="text-center py-8">
                    <i class="fas fa-search text-4xl text-gray-300"></i>
                    <p class="mt-2 text-gray-600">No products found</p>
                </div>

                <!-- Quick Access Content -->
                <div x-show="!loading && !searchQuery">
                    <!-- Favorite Products -->
                    <div x-show="activeTab === 'favorites'">
                        <div x-show="favoriteProducts.length === 0" class="text-center py-8">
                            <i class="fas fa-star text-4xl text-gray-300"></i>
                            <p class="mt-2 text-gray-600">No favorite products yet</p>
                            <p class="text-sm text-gray-500">Products will appear here based on sales frequency</p>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <template x-for="product in favoriteProducts" :key="product.id">
                                <div 
                                    @click="addToCart(product)"
                                    class="border border-gray-200 rounded-lg p-4 hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition"
                                >
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center">
                                                <h3 class="font-semibold text-gray-800" x-text="product.name"></h3>
                                                <i class="fas fa-star text-yellow-500 ml-2 text-sm"></i>
                                            </div>
                                            <p class="text-sm text-gray-600">
                                                SKU: <span x-text="product.sku"></span>
                                            </p>
                                            <p class="text-xs text-gray-500">
                                                <span x-text="product.karat + 'K'"></span> • 
                                                <span x-text="product.weight_grams + 'g'"></span>
                                                <span x-show="product.sales_count" class="ml-2">
                                                    • <span x-text="product.sales_count"></span> sales
                                                </span>
                                            </p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-lg font-bold text-blue-600">
                                                $<span x-text="parseFloat(product.selling_price).toFixed(2)"></span>
                                            </p>
                                            <p class="text-xs text-gray-500">
                                                Stock: <span x-text="product.quantity"></span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div x-show="activeTab === 'recent'">
                        <div x-show="recentTransactions.length === 0" class="text-center py-8">
                            <i class="fas fa-clock text-4xl text-gray-300"></i>
                            <p class="mt-2 text-gray-600">No recent transactions</p>
                        </div>
                        
                        <div class="space-y-3">
                            <template x-for="transaction in recentTransactions" :key="transaction.id">
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center">
                                                <h3 class="font-semibold text-gray-800" x-text="transaction.sale_number"></h3>
                                                <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded">
                                                    <span x-text="transaction.status"></span>
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-600" x-text="transaction.customer_name || 'Walk-in Customer'"></p>
                                            <p class="text-xs text-gray-500" x-text="new Date(transaction.created_at).toLocaleString()"></p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-lg font-bold text-blue-600">
                                                $<span x-text="parseFloat(transaction.total).toFixed(2)"></span>
                                            </p>
                                            <p class="text-xs text-gray-500">
                                                <span x-text="transaction.items_count"></span> items
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Search Results (when searching) -->

                <div class="grid grid-cols-1 gap-3">
                    <template x-for="product in searchResults" :key="product.id">
                        <div 
                            @click="addToCart(product)"
                            class="border border-gray-200 rounded-lg p-4 hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition"
                        >
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800" x-text="product.name"></h3>
                                    <p class="text-sm text-gray-600">
                                        SKU: <span x-text="product.sku"></span>
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        <span x-text="product.karat + 'K'"></span> • 
                                        <span x-text="product.weight_grams + 'g'"></span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-blue-600">
                                        $<span x-text="parseFloat(product.selling_price).toFixed(2)"></span>
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        Stock: <span x-text="product.quantity"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Right Panel: Cart & Checkout -->
        <div class="w-1/2 bg-gray-50 flex flex-col">
            <!-- Cart Header -->
            <div class="p-4 bg-white border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Cart (<span x-text="cart.length"></span>)
                    </h2>
                    <button 
                        @click="clearCart()"
                        x-show="cart.length > 0"
                        class="text-red-600 hover:text-red-800 text-sm"
                    >
                        <i class="fas fa-trash mr-1"></i>
                        Clear
                    </button>
                </div>
            </div>


            <!-- Cart Items -->
            <div class="flex-1 overflow-y-auto p-4">
                <div x-show="cart.length === 0" class="text-center py-12">
                    <i class="fas fa-shopping-cart text-5xl text-gray-300"></i>
                    <p class="mt-4 text-gray-600">Cart is empty</p>
                    <p class="text-sm text-gray-500">Add products to begin</p>
                </div>

                <div class="space-y-3">
                    <template x-for="(item, index) in cart" :key="index">
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800" x-text="item.name"></h4>
                                    <p class="text-sm text-gray-600" x-text="item.sku"></p>
                                </div>
                                <button 
                                    @click="removeFromCart(index)"
                                    class="text-red-600 hover:text-red-800"
                                >
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <button 
                                        @click="updateQuantity(index, item.quantity - 1)"
                                        class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded"
                                    >
                                        <i class="fas fa-minus text-xs"></i>
                                    </button>
                                    <input 
                                        type="number" 
                                        x-model.number="item.quantity"
                                        @change="updateQuantity(index, item.quantity)"
                                        min="1"
                                        :max="item.available_quantity"
                                        class="w-16 text-center border border-gray-300 rounded py-1"
                                    >
                                    <button 
                                        @click="updateQuantity(index, item.quantity + 1)"
                                        class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded"
                                    >
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">
                                        $<span x-text="parseFloat(item.unit_price).toFixed(2)"></span> each
                                    </p>
                                    <p class="font-bold text-blue-600">
                                        $<span x-text="(item.unit_price * item.quantity).toFixed(2)"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>


            <!-- Checkout Section -->
            <div class="bg-white border-t border-gray-200 p-4">
                <!-- Customer Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-1"></i>
                        Customer (Optional)
                    </label>
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            x-model="customerSearch"
                            @input.debounce.300ms="searchCustomers()"
                            placeholder="Search customer..."
                            class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                        >
                        <button 
                            @click="showCustomerQuickAdd = true"
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                        >
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <!-- Customer Search Results -->
                    <div x-show="customerResults.length > 0" class="mt-2 border border-gray-200 rounded max-h-40 overflow-y-auto">
                        <template x-for="customer in customerResults" :key="customer.id">
                            <div 
                                @click="selectCustomer(customer)"
                                class="p-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                            >
                                <p class="font-medium text-sm" x-text="customer.full_name"></p>
                                <p class="text-xs text-gray-600" x-text="customer.phone"></p>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Selected Customer -->
                    <div x-show="selectedCustomer" class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded flex justify-between items-center">
                        <div>
                            <p class="font-medium text-sm" x-text="selectedCustomer?.full_name"></p>
                            <p class="text-xs text-gray-600" x-text="selectedCustomer?.phone"></p>
                        </div>
                        <button @click="selectedCustomer = null" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Terminal Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-desktop mr-1"></i>
                        Terminal
                    </label>
                    <select 
                        x-model="selectedTerminalId"
                        @change="loadTerminal()"
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="">Select Terminal</option>
                        {% for terminal in terminals %}
                        <option value="{{ terminal.id }}">{{ terminal.terminal_id }} - {{ terminal.branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>


                <!-- Payment Method -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-credit-card mr-1"></i>
                        Payment Method
                    </label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="paymentMethod = 'CASH'"
                            :class="paymentMethod === 'CASH' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
                            class="py-2 rounded hover:bg-blue-700 hover:text-white transition"
                        >
                            <i class="fas fa-money-bill-wave"></i>
                            <span class="block text-xs mt-1">Cash</span>
                        </button>
                        <button 
                            @click="paymentMethod = 'CARD'"
                            :class="paymentMethod === 'CARD' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
                            class="py-2 rounded hover:bg-blue-700 hover:text-white transition"
                        >
                            <i class="fas fa-credit-card"></i>
                            <span class="block text-xs mt-1">Card</span>
                        </button>
                        <button 
                            @click="paymentMethod = 'STORE_CREDIT'"
                            :class="paymentMethod === 'STORE_CREDIT' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
                            class="py-2 rounded hover:bg-blue-700 hover:text-white transition"
                        >
                            <i class="fas fa-gift"></i>
                            <span class="block text-xs mt-1">Credit</span>
                        </button>
                    </div>
                </div>

                <!-- Totals -->
                <div class="space-y-2 mb-4 border-t border-gray-200 pt-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Subtotal:</span>
                        <span class="font-medium">$<span x-text="subtotal.toFixed(2)"></span></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Tax (10%):</span>
                        <span class="font-medium">$<span x-text="tax.toFixed(2)"></span></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Discount:</span>
                        <input 
                            type="number" 
                            x-model.number="discount"
                            min="0"
                            :max="subtotal"
                            step="0.01"
                            class="w-24 text-right px-2 py-1 border border-gray-300 rounded"
                        >
                    </div>
                    <div class="flex justify-between text-lg font-bold border-t border-gray-300 pt-2">
                        <span>Total:</span>
                        <span class="text-blue-600">$<span x-text="total.toFixed(2)"></span></span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button 
                        @click="holdSale()"
                        :disabled="cart.length === 0"
                        class="py-3 bg-yellow-500 text-white rounded hover:bg-yellow-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        <i class="fas fa-pause mr-2"></i>
                        Hold
                    </button>
                    <button 
                        @click="completeSale()"
                        :disabled="cart.length === 0 || !selectedTerminalId || processing"
                        class="py-3 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        <i class="fas fa-check mr-2"></i>
                        <span x-text="processing ? 'Processing...' : 'Complete Sale'"></span>
                    </button>
                </div>
                
                <!-- Receipt Actions -->
                <div class="grid grid-cols-2 gap-2">
                    <button 
                        @click="showReceiptSearch = true"
                        class="py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                    >
                        <i class="fas fa-receipt mr-1"></i>
                        Reprint Receipt
                    </button>
                    <button 
                        @click="loadHeldSales()"
                        class="py-2 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm"
                    >
                        <i class="fas fa-list mr-1"></i>
                        Held Sales
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Customer Quick Add Modal -->
<div 
    x-show="showCustomerQuickAdd" 
    x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    @click.self="showCustomerQuickAdd = false"
>
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-4">Quick Add Customer</h3>
        <form @submit.prevent="quickAddCustomer()">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                    <input 
                        type="text" 
                        x-model="newCustomer.first_name"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                    <input 
                        type="text" 
                        x-model="newCustomer.last_name"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                    <input 
                        type="tel" 
                        x-model="newCustomer.phone"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input 
                        type="email" 
                        x-model="newCustomer.email"
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button 
                    type="button"
                    @click="showCustomerQuickAdd = false"
                    class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100"
                >
                    Cancel
                </button>
                <button 
                    type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                    Add Customer
                </button>
            </div>
        </form>
    </div>
</div>


<!-- Receipt Search Modal -->
<div 
    x-show="showReceiptSearch" 
    x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    @click.self="showReceiptSearch = false"
>
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-96 overflow-hidden">
        <h3 class="text-xl font-bold mb-4">Search Receipts</h3>
        
        <!-- Search Input -->
        <div class="mb-4">
            <input 
                type="text" 
                x-model="receiptSearchQuery"
                @input.debounce.300ms="searchReceipts()"
                placeholder="Search by sale number or customer name..."
                class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                autofocus
            >
        </div>
        
        <!-- Search Results -->
        <div class="max-h-64 overflow-y-auto mb-4">
            <div x-show="receiptSearchResults.length === 0 && receiptSearchQuery" class="text-center py-8 text-gray-500">
                No receipts found
            </div>
            
            <div class="space-y-2">
                <template x-for="sale in receiptSearchResults" :key="sale.id">
                    <div class="border border-gray-200 rounded p-3 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-semibold" x-text="sale.sale_number"></div>
                                <div class="text-sm text-gray-600" x-text="sale.customer_name || 'Walk-in'"></div>
                                <div class="text-xs text-gray-500" x-text="new Date(sale.created_at).toLocaleString()"></div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-blue-600" x-text="'$' + parseFloat(sale.total).toFixed(2)"></div>
                                <div class="flex space-x-1 mt-2">
                                    <button 
                                        @click="printReceipt(sale, 'standard')"
                                        class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                                        title="Print Standard Receipt"
                                    >
                                        <i class="fas fa-print"></i>
                                    </button>
                                    <button 
                                        @click="printReceipt(sale, 'thermal')"
                                        class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600"
                                        title="Print Thermal Receipt"
                                    >
                                        <i class="fas fa-receipt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Close Button -->
        <div class="flex justify-end">
            <button 
                @click="showReceiptSearch = false"
                class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100"
            >
                Close
            </button>
        </div>
    </div>
</div>


<!-- Held Sales Modal -->
<div 
    x-show="showHeldSales" 
    x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    @click.self="showHeldSales = false"
>
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-96 overflow-hidden">
        <h3 class="text-xl font-bold mb-4">Held Sales</h3>
        
        <!-- Held Sales List -->
        <div class="max-h-64 overflow-y-auto mb-4">
            <div x-show="heldSales.length === 0" class="text-center py-8 text-gray-500">
                No held sales found
            </div>
            
            <div class="space-y-2">
                <template x-for="sale in heldSales" :key="sale.id">
                    <div class="border border-gray-200 rounded p-3 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-semibold" x-text="sale.sale_number"></div>
                                <div class="text-sm text-gray-600" x-text="sale.customer_name || 'Walk-in'"></div>
                                <div class="text-xs text-gray-500" x-text="new Date(sale.created_at).toLocaleString()"></div>
                                <div class="text-xs text-yellow-600">
                                    <i class="fas fa-pause mr-1"></i>
                                    On Hold
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-blue-600" x-text="'$' + parseFloat(sale.total).toFixed(2)"></div>
                                <button 
                                    @click="resumeHeldSale(sale)"
                                    class="mt-2 px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600"
                                >
                                    Resume
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Close Button -->
        <div class="flex justify-end">
            <button 
                @click="showHeldSales = false"
                class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100"
            >
                Close
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Load offline functionality scripts -->
<script src="/static/js/pos-indexeddb.js"></script>
<script src="/static/js/pos-offline.js"></script>

<script>
function posApp() {
    return {
        // State
        searchQuery: '',
        searchResults: [],
        loading: false,
        cart: [],
        selectedCustomer: null,
        customerSearch: '',
        customerResults: [],
        selectedTerminalId: '',
        selectedTerminal: null,
        paymentMethod: 'CASH',
        discount: 0,
        processing: false,
        showCustomerQuickAdd: false,
        newCustomer: {
            first_name: '',
            last_name: '',
            phone: '',
            email: ''
        },
        showReceiptSearch: false,
        receiptSearchQuery: '',
        receiptSearchResults: [],
        showHeldSales: false,
        heldSales: [],
        
        // Offline mode state
        isOnline: navigator.onLine,
        offlineManager: null,
        pendingTransactions: 0,
        showOfflineStatus: false,
        
        // Quick access state
        activeTab: 'favorites',
        favoriteProducts: [],
        recentTransactions: [],

        // Computed
        get subtotal() {
            return this.cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
        },
        get tax() {
            return this.subtotal * 0.10; // 10% tax
        },
        get total() {
            return this.subtotal + this.tax - this.discount;
        },

        // Methods
        async init() {
            // Initialize offline manager
            try {
                this.offlineManager = new POSOfflineManager();
                await this.offlineManager.init();
                
                // Set up offline event listeners
                this.setupOfflineEventListeners();
                
                console.log('[POS] Offline manager initialized successfully');
            } catch (error) {
                console.error('[POS] Failed to initialize offline manager:', error);
                // Continue without offline functionality
            }
            
            // Load quick access data
            await this.loadFavoriteProducts();
            await this.loadRecentTransactions();
            
            // Focus on search input
            this.$nextTick(() => {
                document.querySelector('input[type="text"]')?.focus();
            });
        },
        
        setupOfflineEventListeners() {
            if (!this.offlineManager) return;
            
            // Listen for online/offline status changes
            this.offlineManager.on('statusChange', (data) => {
                this.isOnline = data.online;
                console.log('[POS] Connection status changed:', data.online ? 'online' : 'offline');
            });
            
            // Listen for offline transactions
            this.offlineManager.on('offlineTransactionCreated', (transaction) => {
                console.log('[POS] Offline transaction created:', transaction.id);
                this.updatePendingTransactionCount();
            });
            
            // Listen for sync completion
            this.offlineManager.on('syncCompleted', (results) => {
                console.log('[POS] Sync completed:', results);
                this.updatePendingTransactionCount();
                
                if (results.success > 0) {
                    this.showSyncSuccessNotification(results);
                }
            });
            
            // Listen for sync conflicts
            this.offlineManager.on('conflictResolutionNeeded', (data) => {
                console.log('[POS] Conflict resolution needed:', data);
                this.handleSyncConflict(data);
            });
        },
        
        async updatePendingTransactionCount() {
            if (this.offlineManager) {
                const stats = await this.offlineManager.getStats();
                this.pendingTransactions = stats.pendingTransactions;
            }
        },
        
        showSyncSuccessNotification(results) {
            // Show a success notification
            const message = `${results.success} transaction(s) synced successfully`;
            if (results.conflicts > 0) {
                message += `, ${results.conflicts} conflict(s) need attention`;
            }
            
            // You could integrate with a toast notification system here
            console.log('[POS] Sync notification:', message);
        },
        
        handleSyncConflict(data) {
            // Handle sync conflicts - could show a modal dialog
            console.log('[POS] Handling sync conflict:', data);
            
            // For now, just alert the user
            alert(`Sync conflict detected for offline transaction. Some items may no longer be available. Please check inventory and retry.`);
        },


        async searchProducts() {
            if (!this.searchQuery.trim()) {
                this.searchResults = [];
                return;
            }

            this.loading = true;
            try {
                // Try online search first
                if (this.isOnline) {
                    const response = await fetch(`/api/pos/search/products/?q=${encodeURIComponent(this.searchQuery)}`, {
                        headers: {
                            'Authorization': 'Bearer ' + this.getToken()
                        }
                    });
                    const data = await response.json();
                    this.searchResults = data.results || [];
                } else {
                    // Use offline search if available
                    if (this.offlineManager && this.offlineManager.db) {
                        this.searchResults = await this.offlineManager.db.searchCachedInventory(this.searchQuery);
                    } else {
                        this.searchResults = [];
                    }
                }
            } catch (error) {
                console.error('Error searching products:', error);
                
                // Try offline search as fallback
                if (this.offlineManager && this.offlineManager.db) {
                    try {
                        this.searchResults = await this.offlineManager.db.searchCachedInventory(this.searchQuery);
                        console.log('[POS] Using cached search results');
                    } catch (offlineError) {
                        console.error('Offline search also failed:', offlineError);
                        this.searchResults = [];
                        alert('Error searching products (offline mode unavailable)');
                    }
                } else {
                    alert('Error searching products');
                }
            } finally {
                this.loading = false;
            }
        },

        addToCart(product) {
            // Check if product already in cart
            const existingIndex = this.cart.findIndex(item => item.id === product.id);
            
            if (existingIndex >= 0) {
                // Increment quantity if already in cart
                const newQuantity = this.cart[existingIndex].quantity + 1;
                if (newQuantity <= product.quantity) {
                    this.cart[existingIndex].quantity = newQuantity;
                } else {
                    alert('Insufficient stock');
                }
            } else {
                // Add new item to cart
                this.cart.push({
                    id: product.id,
                    name: product.name,
                    sku: product.sku,
                    unit_price: parseFloat(product.selling_price),
                    quantity: 1,
                    available_quantity: product.quantity
                });
            }

            // Clear search
            this.searchQuery = '';
            this.searchResults = [];
        },

        removeFromCart(index) {
            this.cart.splice(index, 1);
        },

        updateQuantity(index, newQuantity) {
            if (newQuantity < 1) {
                this.removeFromCart(index);
                return;
            }

            if (newQuantity > this.cart[index].available_quantity) {
                alert('Insufficient stock');
                return;
            }

            this.cart[index].quantity = newQuantity;
        },

        clearCart() {
            if (confirm('Are you sure you want to clear the cart?')) {
                this.cart = [];
                this.selectedCustomer = null;
                this.discount = 0;
            }
        },


        async searchCustomers() {
            if (!this.customerSearch.trim()) {
                this.customerResults = [];
                return;
            }

            try {
                // Try online search first
                if (this.isOnline) {
                    const response = await fetch(`/api/pos/search/customers/?q=${encodeURIComponent(this.customerSearch)}`, {
                        headers: {
                            'Authorization': 'Bearer ' + this.getToken()
                        }
                    });
                    const data = await response.json();
                    this.customerResults = data.results || [];
                } else {
                    // Use offline search if available
                    if (this.offlineManager && this.offlineManager.db) {
                        this.customerResults = await this.offlineManager.db.searchCachedCustomers(this.customerSearch);
                    } else {
                        this.customerResults = [];
                    }
                }
            } catch (error) {
                console.error('Error searching customers:', error);
                
                // Try offline search as fallback
                if (this.offlineManager && this.offlineManager.db) {
                    try {
                        this.customerResults = await this.offlineManager.db.searchCachedCustomers(this.customerSearch);
                        console.log('[POS] Using cached customer search results');
                    } catch (offlineError) {
                        console.error('Offline customer search failed:', offlineError);
                        this.customerResults = [];
                    }
                }
            }
        },

        selectCustomer(customer) {
            this.selectedCustomer = customer;
            this.customerSearch = '';
            this.customerResults = [];
        },

        async quickAddCustomer() {
            try {
                const response = await fetch('/api/pos/customers/quick-add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.getToken(),
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(this.newCustomer)
                });

                if (response.ok) {
                    const customer = await response.json();
                    this.selectedCustomer = customer;
                    this.showCustomerQuickAdd = false;
                    // Reset form
                    this.newCustomer = {
                        first_name: '',
                        last_name: '',
                        phone: '',
                        email: ''
                    };
                } else {
                    const error = await response.json();
                    alert('Error adding customer: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('Error adding customer:', error);
                alert('Error adding customer');
            }
        },

        loadTerminal() {
            const terminals = {{ terminals|safe|default:"[]" }};
            this.selectedTerminal = terminals.find(t => t.id === this.selectedTerminalId);
        },


        async completeSale() {
            if (this.cart.length === 0) {
                alert('Cart is empty');
                return;
            }

            if (!this.selectedTerminalId) {
                alert('Please select a terminal');
                return;
            }

            this.processing = true;

            try {
                const saleData = {
                    customer_id: this.selectedCustomer?.id || null,
                    terminal_id: this.selectedTerminalId,
                    items: this.cart.map(item => ({
                        inventory_item_id: item.id,
                        quantity: item.quantity,
                        unit_price: item.unit_price.toString()
                    })),
                    payment_method: this.paymentMethod,
                    tax_rate: '10.00',
                    discount: this.discount.toString(),
                    status: 'COMPLETED'
                };

                const response = await fetch('/api/pos/sales/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.getToken(),
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(saleData)
                });

                if (response.ok) {
                    const sale = await response.json();
                    
                    // Check if this was an offline transaction
                    const isOfflineTransaction = response.headers.get('X-Offline-Mode') === 'true';
                    
                    if (isOfflineTransaction) {
                        // Show offline transaction message
                        alert(`Sale saved offline!\nSale Number: ${sale.sale_number}\nTotal: $${sale.total}\n\nTransaction will sync when connection is restored.`);
                        
                        // Update pending transaction count
                        await this.updatePendingTransactionCount();
                    } else {
                        // Generate and show receipt for online transaction
                        await this.generateReceipt(sale.id, sale.sale_number, sale.total);
                    }
                    
                    // Reset cart
                    this.clearCart();
                    this.paymentMethod = 'CASH';
                } else {
                    const error = await response.json();
                    
                    // Handle offline mode errors
                    if (error.error === 'Offline mode') {
                        alert('Transaction saved for offline processing. Will sync when connection is restored.');
                    } else {
                        alert('Error completing sale: ' + (error.detail || JSON.stringify(error)));
                    }
                }
            } catch (error) {
                console.error('Error completing sale:', error);
                
                // Check if we're offline and the service worker handled it
                if (!this.isOnline) {
                    alert('Connection lost. Transaction may have been saved offline and will sync when connection is restored.');
                } else {
                    alert('Error completing sale');
                }
            } finally {
                this.processing = false;
            }
        },

        async holdSale() {
            alert('Hold sale feature will be implemented in task 5.3');
        },

        getToken() {
            // In production, this should get the JWT token from localStorage or cookie
            // For now, we'll use session authentication
            return '';
        },

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        },

        async generateReceipt(saleId, saleNumber, total) {
            try {
                // Generate receipt
                const receiptResponse = await fetch(`/api/receipts/${saleId}/generate/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.getToken(),
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify({
                        format_type: 'standard',
                        auto_print: false,
                        save_receipt: true
                    })
                });

                if (receiptResponse.ok) {
                    const receiptData = await receiptResponse.json();
                    
                    // Show success message with receipt options
                    const message = `Sale completed successfully!\nSale Number: ${saleNumber}\nTotal: $${total}\n\nReceipt generated successfully!`;
                    
                    if (confirm(message + '\n\nWould you like to print the receipt?')) {
                        // Open receipt in new window for printing
                        window.open(receiptData.receipt_url, '_blank', 'width=800,height=600');
                    }
                } else {
                    // Fallback to simple success message
                    alert(`Sale completed successfully!\nSale Number: ${saleNumber}\nTotal: $${total}\n\nNote: Receipt generation failed.`);
                }
            } catch (error) {
                console.error('Receipt generation error:', error);
                // Fallback to simple success message
                alert(`Sale completed successfully!\nSale Number: ${saleNumber}\nTotal: $${total}\n\nNote: Receipt generation failed.`);
            }
        },

        async searchReceipts() {
            if (!this.receiptSearchQuery.trim()) {
                this.receiptSearchResults = [];
                return;
            }

            try {
                const response = await fetch(`/api/sales/?search=${encodeURIComponent(this.receiptSearchQuery)}&limit=10`, {
                    headers: {
                        'Authorization': 'Bearer ' + this.getToken()
                    }
                });
                const data = await response.json();
                this.receiptSearchResults = data.results || [];
            } catch (error) {
                console.error('Error searching receipts:', error);
                alert('Error searching receipts');
            }
        },

        async printReceipt(sale, format = 'standard') {
            try {
                const receiptUrl = `/receipts/html/${sale.id}/${format}/?auto_print=true`;
                window.open(receiptUrl, '_blank', 'width=800,height=600');
            } catch (error) {
                console.error('Error printing receipt:', error);
                alert('Error printing receipt');
            }
        },

        async loadHeldSales() {
            try {
                const response = await fetch('/api/pos/sales/held/', {
                    headers: {
                        'Authorization': 'Bearer ' + this.getToken()
                    }
                });
                const data = await response.json();
                this.heldSales = data.held_sales || [];
                this.showHeldSales = true;
            } catch (error) {
                console.error('Error loading held sales:', error);
                alert('Error loading held sales');
            }
        },

        async resumeHeldSale(sale) {
            // This would load the held sale back into the cart
            // For now, just show the sale details
            alert(`Resume sale: ${sale.sale_number}\nTotal: $${sale.total}\n\nNote: Resume functionality will be implemented in a future update.`);
            this.showHeldSales = false;
        },
        
        async manualSync() {
            if (!this.offlineManager || !this.isOnline) {
                return;
            }
            
            try {
                console.log('[POS] Manual sync triggered');
                await this.offlineManager.forcSync();
                await this.updatePendingTransactionCount();
            } catch (error) {
                console.error('[POS] Manual sync failed:', error);
                alert('Sync failed: ' + error.message);
            }
        },
        
        async loadFavoriteProducts() {
            try {
                if (this.isOnline) {
                    const response = await fetch('/api/pos/favorite-products/', {
                        headers: {
                            'Authorization': 'Bearer ' + this.getToken()
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.favoriteProducts = data.results || [];
                    }
                } else {
                    // Use cached data when offline
                    if (this.offlineManager && this.offlineManager.db) {
                        // Get most frequently accessed items from cache
                        const cachedItems = await this.offlineManager.db.searchCachedInventory('');
                        this.favoriteProducts = cachedItems.slice(0, 10);
                    }
                }
            } catch (error) {
                console.error('Error loading favorite products:', error);
            }
        },
        
        async loadRecentTransactions() {
            try {
                if (this.isOnline) {
                    const response = await fetch('/api/pos/recent-transactions/', {
                        headers: {
                            'Authorization': 'Bearer ' + this.getToken()
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.recentTransactions = data.results || [];
                    }
                } else {
                    // Show offline transactions when offline
                    if (this.offlineManager && this.offlineManager.db) {
                        const offlineTransactions = await this.offlineManager.db.getTransactionHistory(10);
                        this.recentTransactions = offlineTransactions.map(tx => ({
                            id: tx.id,
                            sale_number: tx.data.sale_number || 'OFFLINE_' + tx.id.slice(-6),
                            total: tx.data.total || '0.00',
                            status: 'OFFLINE_PENDING',
                            customer_name: tx.data.customer_name || null,
                            created_at: new Date(tx.timestamp).toISOString(),
                            items_count: tx.data.items ? tx.data.items.length : 0
                        }));
                    }
                }
            } catch (error) {
                console.error('Error loading recent transactions:', error);
            }
        }
    }
}
</script>

<style>
[x-cloak] {
    display: none !important;
}
</style>
{% endblock %}
