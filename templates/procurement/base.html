{% extends "base.html" %}

{% block title %}Procurement - {{ block.super }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-xl font-semibold text-gray-900">Procurement</h1>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="{% url 'procurement:supplier_list' %}" 
                           class="{% if 'supplier' in request.resolver_match.url_name %}border-indigo-500 text-gray-900{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Suppliers
                        </a>
                        <a href="{% url 'procurement:purchase_order_list' %}" 
                           class="{% if 'purchase_order' in request.resolver_match.url_name %}border-indigo-500 text-gray-900{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Purchase Orders
                        </a>
                        <a href="{% url 'procurement:goods_receipt_list' %}" 
                           class="{% if 'goods_receipt' in request.resolver_match.url_name %}border-indigo-500 text-gray-900{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Goods Receipts
                        </a>
                    </div>
                </div>
                <div class="flex items-center">
                    <a href="{% url 'procurement:purchase_order_create' %}" 
                       class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        New Purchase Order
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        {% block main_content %}
        {% endblock %}
    </main>
</div>
{% endblock %}

{% block extra_css %}
<style>
.rating-stars {
    color: #fbbf24;
    cursor: pointer;
}
.rating-stars .star {
    font-size: 1.2rem;
    margin-right: 2px;
}
.rating-stars .star:hover,
.rating-stars .star.active {
    color: #f59e0b;
}
.document-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
}
.document-status.valid {
    background-color: #d1fae5;
    color: #065f46;
}
.document-status.expiring {
    background-color: #fef3c7;
    color: #92400e;
}
.document-status.expired {
    background-color: #fee2e2;
    color: #991b1b;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Rating system functionality
function updateRating(supplierId, rating) {
    fetch(`/procurement/suppliers/${supplierId}/rating/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `rating=${rating}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update star display
            updateStarDisplay(supplierId, data.rating);
            // Show success message
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Failed to update rating', 'error');
    });
}

function updateStarDisplay(supplierId, rating) {
    const container = document.querySelector(`[data-supplier-id="${supplierId}"] .rating-stars`);
    if (container) {
        const stars = container.querySelectorAll('.star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
                star.innerHTML = '★';
            } else {
                star.classList.remove('active');
                star.innerHTML = '☆';
            }
        });
    }
}

function showMessage(message, type) {
    // Simple message display - you can enhance this with a proper notification system
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.messages-container') || document.querySelector('.container');
    if (container) {
        container.insertAdjacentHTML('afterbegin', alertHtml);
    }
}

// Initialize rating stars
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.rating-stars').forEach(container => {
        const supplierId = container.closest('[data-supplier-id]').dataset.supplierId;
        const stars = container.querySelectorAll('.star');
        
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                updateRating(supplierId, index + 1);
            });
        });
    });
});
</script>
{% endblock %}