#!/bin/bash

# Enhanced pre-commit hook with auto-fixing and clear feedback
# This script automatically fixes black and isort issues, but blocks on flake8 errors

set -e

echo "ğŸ” Running pre-commit checks via Docker..."

# Function to run docker command with proper error handling
run_docker_cmd() {
    local service="$1"
    local cmd="$2"
    local description="$3"
    
    echo "ğŸ” Running $description..."
    if docker compose exec -T "$service" $cmd; then
        echo "âœ… $description passed!"
        return 0
    else
        echo "âŒ $description failed!"
        return 1
    fi
}

# Auto-fix formatting with black
echo "ğŸ”§ Auto-fixing code formatting with black..."
if docker compose exec -T web black --line-length=100 .; then
    echo "âœ… Black formatting applied!"
else
    echo "âŒ Black formatting failed!"
    exit 1
fi

# Auto-fix import sorting with isort
echo "ğŸ”§ Auto-fixing import sorting with isort..."
if docker compose exec -T web isort --profile black --line-length 100 .; then
    echo "âœ… Import sorting applied!"
else
    echo "âŒ Import sorting failed!"
    exit 1
fi

# Check for linting issues with flake8 (blocks commit)
echo "âŒ Checking code quality with flake8 (manual fixes required)..."
if docker compose exec -T web flake8 --max-line-length=100 --extend-ignore=E203,W503 .; then
    echo "âœ… All flake8 checks passed!"
else
    echo ""
    echo "ğŸ’¡ COMMIT BLOCKED: Please fix the flake8 issues above manually."
    echo "   Common fixes:"
    echo "   - Remove unused imports (F401)"
    echo "   - Remove unused variables (F841)" 
    echo "   - Fix undefined names (F821)"
    echo "   - Add missing imports"
    echo ""
    echo "   After fixing, try committing again."
    exit 1
fi

echo ""
echo "ğŸ‰ All pre-commit checks passed! Your code is ready to commit."
echo "   âœ… Code formatted with black"
echo "   âœ… Imports sorted with isort" 
echo "   âœ… Code quality verified with flake8"
echo ""