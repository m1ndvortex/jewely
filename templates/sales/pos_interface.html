{% extends "base.html" %}

{% block title %}Point of Sale - Jewelry Shop{% endblock %}

{% block content %}
<div x-data="posApp()" x-init="init()" class="h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">
                <i class="fas fa-cash-register mr-2"></i>
                Point of Sale
            </h1>
            <div class="flex items-center space-x-4">
                <div class="text-sm">
                    <i class="fas fa-user mr-1"></i>
                    <span>{{ user.get_full_name }}</span>
                </div>
                <div class="text-sm">
                    <i class="fas fa-store mr-1"></i>
                    <span x-text="selectedTerminal ? selectedTerminal.terminal_id : 'Select Terminal'"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Panel: Product Search -->
        <div class="w-1/2 bg-white border-r border-gray-300 flex flex-col">
            <!-- Search Bar -->
            <div class="p-4 border-b border-gray-200">
                <div class="relative">
                    <input 
                        type="text" 
                        x-model="searchQuery"
                        @input.debounce.300ms="searchProducts()"
                        @keydown.enter="searchProducts()"
                        placeholder="Search by SKU, name, or scan barcode..."
                        class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        autofocus
                    >
                    <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                </div>
            </div>


            <!-- Product Results -->
            <div class="flex-1 overflow-y-auto p-4">
                <div x-show="loading" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i>
                    <p class="mt-2 text-gray-600">Searching...</p>
                </div>

                <div x-show="!loading && searchResults.length === 0 && searchQuery" class="text-center py-8">
                    <i class="fas fa-search text-4xl text-gray-300"></i>
                    <p class="mt-2 text-gray-600">No products found</p>
                </div>

                <div x-show="!loading && searchResults.length === 0 && !searchQuery" class="text-center py-8">
                    <i class="fas fa-barcode text-4xl text-gray-300"></i>
                    <p class="mt-2 text-gray-600">Search or scan a product to begin</p>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <template x-for="product in searchResults" :key="product.id">
                        <div 
                            @click="addToCart(product)"
                            class="border border-gray-200 rounded-lg p-4 hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition"
                        >
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800" x-text="product.name"></h3>
                                    <p class="text-sm text-gray-600">
                                        SKU: <span x-text="product.sku"></span>
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        <span x-text="product.karat + 'K'"></span> â€¢ 
                                        <span x-text="product.weight_grams + 'g'"></span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-blue-600">
                                        $<span x-text="parseFloat(product.selling_price).toFixed(2)"></span>
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        Stock: <span x-text="product.quantity"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Right Panel: Cart & Checkout -->
        <div class="w-1/2 bg-gray-50 flex flex-col">
            <!-- Cart Header -->
            <div class="p-4 bg-white border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Cart (<span x-text="cart.length"></span>)
                    </h2>
                    <button 
                        @click="clearCart()"
                        x-show="cart.length > 0"
                        class="text-red-600 hover:text-red-800 text-sm"
                    >
                        <i class="fas fa-trash mr-1"></i>
                        Clear
                    </button>
                </div>
            </div>


            <!-- Cart Items -->
            <div class="flex-1 overflow-y-auto p-4">
                <div x-show="cart.length === 0" class="text-center py-12">
                    <i class="fas fa-shopping-cart text-5xl text-gray-300"></i>
                    <p class="mt-4 text-gray-600">Cart is empty</p>
                    <p class="text-sm text-gray-500">Add products to begin</p>
                </div>

                <div class="space-y-3">
                    <template x-for="(item, index) in cart" :key="index">
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800" x-text="item.name"></h4>
                                    <p class="text-sm text-gray-600" x-text="item.sku"></p>
                                </div>
                                <button 
                                    @click="removeFromCart(index)"
                                    class="text-red-600 hover:text-red-800"
                                >
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <button 
                                        @click="updateQuantity(index, item.quantity - 1)"
                                        class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded"
                                    >
                                        <i class="fas fa-minus text-xs"></i>
                                    </button>
                                    <input 
                                        type="number" 
                                        x-model.number="item.quantity"
                                        @change="updateQuantity(index, item.quantity)"
                                        min="1"
                                        :max="item.available_quantity"
                                        class="w-16 text-center border border-gray-300 rounded py-1"
                                    >
                                    <button 
                                        @click="updateQuantity(index, item.quantity + 1)"
                                        class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded"
                                    >
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">
                                        $<span x-text="parseFloat(item.unit_price).toFixed(2)"></span> each
                                    </p>
                                    <p class="font-bold text-blue-600">
                                        $<span x-text="(item.unit_price * item.quantity).toFixed(2)"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>


            <!-- Checkout Section -->
            <div class="bg-white border-t border-gray-200 p-4">
                <!-- Customer Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-1"></i>
                        Customer (Optional)
                    </label>
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            x-model="customerSearch"
                            @input.debounce.300ms="searchCustomers()"
                            placeholder="Search customer..."
                            class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                        >
                        <button 
                            @click="showCustomerQuickAdd = true"
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                        >
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <!-- Customer Search Results -->
                    <div x-show="customerResults.length > 0" class="mt-2 border border-gray-200 rounded max-h-40 overflow-y-auto">
                        <template x-for="customer in customerResults" :key="customer.id">
                            <div 
                                @click="selectCustomer(customer)"
                                class="p-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                            >
                                <p class="font-medium text-sm" x-text="customer.full_name"></p>
                                <p class="text-xs text-gray-600" x-text="customer.phone"></p>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Selected Customer -->
                    <div x-show="selectedCustomer" class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded flex justify-between items-center">
                        <div>
                            <p class="font-medium text-sm" x-text="selectedCustomer?.full_name"></p>
                            <p class="text-xs text-gray-600" x-text="selectedCustomer?.phone"></p>
                        </div>
                        <button @click="selectedCustomer = null" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Terminal Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-desktop mr-1"></i>
                        Terminal
                    </label>
                    <select 
                        x-model="selectedTerminalId"
                        @change="loadTerminal()"
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="">Select Terminal</option>
                        {% for terminal in terminals %}
                        <option value="{{ terminal.id }}">{{ terminal.terminal_id }} - {{ terminal.branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>


                <!-- Payment Method -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-credit-card mr-1"></i>
                        Payment Method
                    </label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            @click="paymentMethod = 'CASH'"
                            :class="paymentMethod === 'CASH' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
                            class="py-2 rounded hover:bg-blue-700 hover:text-white transition"
                        >
                            <i class="fas fa-money-bill-wave"></i>
                            <span class="block text-xs mt-1">Cash</span>
                        </button>
                        <button 
                            @click="paymentMethod = 'CARD'"
                            :class="paymentMethod === 'CARD' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
                            class="py-2 rounded hover:bg-blue-700 hover:text-white transition"
                        >
                            <i class="fas fa-credit-card"></i>
                            <span class="block text-xs mt-1">Card</span>
                        </button>
                        <button 
                            @click="paymentMethod = 'STORE_CREDIT'"
                            :class="paymentMethod === 'STORE_CREDIT' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
                            class="py-2 rounded hover:bg-blue-700 hover:text-white transition"
                        >
                            <i class="fas fa-gift"></i>
                            <span class="block text-xs mt-1">Credit</span>
                        </button>
                    </div>
                </div>

                <!-- Totals -->
                <div class="space-y-2 mb-4 border-t border-gray-200 pt-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Subtotal:</span>
                        <span class="font-medium">$<span x-text="subtotal.toFixed(2)"></span></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Tax (10%):</span>
                        <span class="font-medium">$<span x-text="tax.toFixed(2)"></span></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Discount:</span>
                        <input 
                            type="number" 
                            x-model.number="discount"
                            min="0"
                            :max="subtotal"
                            step="0.01"
                            class="w-24 text-right px-2 py-1 border border-gray-300 rounded"
                        >
                    </div>
                    <div class="flex justify-between text-lg font-bold border-t border-gray-300 pt-2">
                        <span>Total:</span>
                        <span class="text-blue-600">$<span x-text="total.toFixed(2)"></span></span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-2">
                    <button 
                        @click="holdSale()"
                        :disabled="cart.length === 0"
                        class="py-3 bg-yellow-500 text-white rounded hover:bg-yellow-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        <i class="fas fa-pause mr-2"></i>
                        Hold
                    </button>
                    <button 
                        @click="completeSale()"
                        :disabled="cart.length === 0 || !selectedTerminalId || processing"
                        class="py-3 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        <i class="fas fa-check mr-2"></i>
                        <span x-text="processing ? 'Processing...' : 'Complete Sale'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Customer Quick Add Modal -->
<div 
    x-show="showCustomerQuickAdd" 
    x-cloak
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    @click.self="showCustomerQuickAdd = false"
>
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-4">Quick Add Customer</h3>
        <form @submit.prevent="quickAddCustomer()">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                    <input 
                        type="text" 
                        x-model="newCustomer.first_name"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                    <input 
                        type="text" 
                        x-model="newCustomer.last_name"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                    <input 
                        type="tel" 
                        x-model="newCustomer.phone"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input 
                        type="email" 
                        x-model="newCustomer.email"
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    >
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button 
                    type="button"
                    @click="showCustomerQuickAdd = false"
                    class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100"
                >
                    Cancel
                </button>
                <button 
                    type="submit"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                    Add Customer
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function posApp() {
    return {
        // State
        searchQuery: '',
        searchResults: [],
        loading: false,
        cart: [],
        selectedCustomer: null,
        customerSearch: '',
        customerResults: [],
        selectedTerminalId: '',
        selectedTerminal: null,
        paymentMethod: 'CASH',
        discount: 0,
        processing: false,
        showCustomerQuickAdd: false,
        newCustomer: {
            first_name: '',
            last_name: '',
            phone: '',
            email: ''
        },

        // Computed
        get subtotal() {
            return this.cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
        },
        get tax() {
            return this.subtotal * 0.10; // 10% tax
        },
        get total() {
            return this.subtotal + this.tax - this.discount;
        },

        // Methods
        init() {
            // Focus on search input
            this.$nextTick(() => {
                document.querySelector('input[type="text"]')?.focus();
            });
        },


        async searchProducts() {
            if (!this.searchQuery.trim()) {
                this.searchResults = [];
                return;
            }

            this.loading = true;
            try {
                const response = await fetch(`/api/pos/search/products/?q=${encodeURIComponent(this.searchQuery)}`, {
                    headers: {
                        'Authorization': 'Bearer ' + this.getToken()
                    }
                });
                const data = await response.json();
                this.searchResults = data.results || [];
            } catch (error) {
                console.error('Error searching products:', error);
                alert('Error searching products');
            } finally {
                this.loading = false;
            }
        },

        addToCart(product) {
            // Check if product already in cart
            const existingIndex = this.cart.findIndex(item => item.id === product.id);
            
            if (existingIndex >= 0) {
                // Increment quantity if already in cart
                const newQuantity = this.cart[existingIndex].quantity + 1;
                if (newQuantity <= product.quantity) {
                    this.cart[existingIndex].quantity = newQuantity;
                } else {
                    alert('Insufficient stock');
                }
            } else {
                // Add new item to cart
                this.cart.push({
                    id: product.id,
                    name: product.name,
                    sku: product.sku,
                    unit_price: parseFloat(product.selling_price),
                    quantity: 1,
                    available_quantity: product.quantity
                });
            }

            // Clear search
            this.searchQuery = '';
            this.searchResults = [];
        },

        removeFromCart(index) {
            this.cart.splice(index, 1);
        },

        updateQuantity(index, newQuantity) {
            if (newQuantity < 1) {
                this.removeFromCart(index);
                return;
            }

            if (newQuantity > this.cart[index].available_quantity) {
                alert('Insufficient stock');
                return;
            }

            this.cart[index].quantity = newQuantity;
        },

        clearCart() {
            if (confirm('Are you sure you want to clear the cart?')) {
                this.cart = [];
                this.selectedCustomer = null;
                this.discount = 0;
            }
        },


        async searchCustomers() {
            if (!this.customerSearch.trim()) {
                this.customerResults = [];
                return;
            }

            try {
                const response = await fetch(`/api/pos/search/customers/?q=${encodeURIComponent(this.customerSearch)}`, {
                    headers: {
                        'Authorization': 'Bearer ' + this.getToken()
                    }
                });
                const data = await response.json();
                this.customerResults = data.results || [];
            } catch (error) {
                console.error('Error searching customers:', error);
            }
        },

        selectCustomer(customer) {
            this.selectedCustomer = customer;
            this.customerSearch = '';
            this.customerResults = [];
        },

        async quickAddCustomer() {
            try {
                const response = await fetch('/api/pos/customers/quick-add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.getToken(),
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(this.newCustomer)
                });

                if (response.ok) {
                    const customer = await response.json();
                    this.selectedCustomer = customer;
                    this.showCustomerQuickAdd = false;
                    // Reset form
                    this.newCustomer = {
                        first_name: '',
                        last_name: '',
                        phone: '',
                        email: ''
                    };
                } else {
                    const error = await response.json();
                    alert('Error adding customer: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('Error adding customer:', error);
                alert('Error adding customer');
            }
        },

        loadTerminal() {
            const terminals = {{ terminals|safe|default:"[]" }};
            this.selectedTerminal = terminals.find(t => t.id === this.selectedTerminalId);
        },


        async completeSale() {
            if (this.cart.length === 0) {
                alert('Cart is empty');
                return;
            }

            if (!this.selectedTerminalId) {
                alert('Please select a terminal');
                return;
            }

            this.processing = true;

            try {
                const saleData = {
                    customer_id: this.selectedCustomer?.id || null,
                    terminal_id: this.selectedTerminalId,
                    items: this.cart.map(item => ({
                        inventory_item_id: item.id,
                        quantity: item.quantity,
                        unit_price: item.unit_price.toString()
                    })),
                    payment_method: this.paymentMethod,
                    tax_rate: '10.00',
                    discount: this.discount.toString(),
                    status: 'COMPLETED'
                };

                const response = await fetch('/api/pos/sales/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.getToken(),
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(saleData)
                });

                if (response.ok) {
                    const sale = await response.json();
                    alert(`Sale completed successfully!\nSale Number: ${sale.sale_number}\nTotal: $${sale.total}`);
                    
                    // Reset cart
                    this.clearCart();
                    this.paymentMethod = 'CASH';
                } else {
                    const error = await response.json();
                    alert('Error completing sale: ' + (error.detail || JSON.stringify(error)));
                }
            } catch (error) {
                console.error('Error completing sale:', error);
                alert('Error completing sale');
            } finally {
                this.processing = false;
            }
        },

        async holdSale() {
            alert('Hold sale feature will be implemented in task 5.3');
        },

        getToken() {
            // In production, this should get the JWT token from localStorage or cookie
            // For now, we'll use session authentication
            return '';
        },

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
    }
}
</script>

<style>
[x-cloak] {
    display: none !important;
}
</style>
{% endblock %}
