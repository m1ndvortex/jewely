# Jewelry SaaS Platform - Main Site Configuration
# Handles HTTP/HTTPS traffic, reverse proxy, static files, and security

# Upstream Django application servers
upstream django_backend {
    # Use least connections load balancing
    least_conn;
    
    # Django web service
    server web:8000 max_fails=3 fail_timeout=30s;
    
    # Add more servers for horizontal scaling:
    # server web2:8000 max_fails=3 fail_timeout=30s;
    # server web3:8000 max_fails=3 fail_timeout=30s;
    
    # Keep connections alive
    keepalive 32;
}

# HTTP Server - Redirect to HTTPS (Production)
# For development, this can serve HTTP directly
server {
    listen 80;
    listen [::]:80;
    server_name _;  # Replace with your domain in production
    
    # Allow Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }
    
    # Security headers (development-safe, no HSTS)
    include /etc/nginx/snippets/security-headers-dev.conf;
    
    # Development mode: Serve HTTP directly
    # Comment out this location block in production
    location / {
        # Rate limiting
        limit_req zone=general burst=20 nodelay;
        limit_conn addr 10;
        
        # Proxy to Django
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://django_backend;
    }
    
    # Static files (development)
    location /static/ {
        alias /app/staticfiles/;
        
        # Apply cache configuration
        include /etc/nginx/snippets/cache.conf;
        
        # Static assets are versioned/hashed, safe to cache aggressively
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Disable access logging for static files (performance)
        access_log off;
        
        # Enable CORS for fonts and other assets if needed
        add_header Access-Control-Allow-Origin "*" always;
    }
    
    # Media files (development)
    location /media/ {
        alias /app/media/;
        
        # Apply cache configuration
        include /etc/nginx/snippets/cache.conf;
        
        # Media files can change, use shorter cache
        expires 7d;
        add_header Cache-Control "public";
        
        # Prevent execution of scripts in media directory
        location ~* \.(php|py|pl|sh|cgi)$ {
            deny all;
        }
    }
    
    # Metrics and health check endpoints
    include /etc/nginx/snippets/metrics.conf;
    
    # WebSocket connections (for real-time features)
    location /ws/ {
        # Rate limiting for WebSocket connections
        limit_req zone=general burst=10 nodelay;
        limit_conn addr 5;
        
        # WebSocket proxy configuration (complete, not proxy-params.conf)
        include /etc/nginx/snippets/websocket-proxy.conf;
        proxy_pass http://django_backend;
    }
    
    # Production mode: Redirect all HTTP to HTTPS
    # Uncomment this in production and comment out the location / block above
    # location / {
    #     return 301 https://$host$request_uri;
    # }
}

# HTTPS Server (Production)
# Uncomment this entire server block for production with SSL
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name your-domain.com www.your-domain.com;  # Replace with your domain
#     
#     # SSL certificates from Let's Encrypt
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#     
#     # SSL configuration
#     include /etc/nginx/snippets/ssl-params.conf;
#     
#     # Security headers
#     include /etc/nginx/snippets/security-headers.conf;
#     
#     # Root directory
#     root /var/www/html;
#     
#     # Logging
#     access_log /var/log/nginx/jewelry-shop-access.log main;
#     error_log /var/log/nginx/jewelry-shop-error.log warn;
#     
#     # Static files
#     location /static/ {
#         alias /app/staticfiles/;
#         
#         # Apply cache configuration with ETags
#         include /etc/nginx/snippets/cache.conf;
#         
#         # Static assets are versioned/hashed, safe to cache aggressively
#         expires 30d;
#         add_header Cache-Control "public, immutable";
#         
#         # Disable access logging for static files (performance)
#         access_log off;
#         
#         # Enable CORS for fonts and other assets if needed
#         add_header Access-Control-Allow-Origin "*" always;
#     }
#     
#     # Media files
#     location /media/ {
#         alias /app/media/;
#         
#         # Apply cache configuration with ETags
#         include /etc/nginx/snippets/cache.conf;
#         
#         # Media files can change, use shorter cache
#         expires 7d;
#         add_header Cache-Control "public";
#         
#         # Prevent execution of scripts in media directory
#         location ~* \.(php|py|pl|sh|cgi)$ {
#             deny all;
#         }
#     }
#     
#     # Admin panel - Stricter rate limiting
#     location /admin/ {
#         limit_req zone=admin burst=10 nodelay;
#         limit_conn addr 5;
#         
#         include /etc/nginx/snippets/proxy-params.conf;
#         proxy_pass http://django_backend;
#     }
#     
#     # Authentication endpoints - Prevent brute force
#     location ~ ^/(accounts/login|api/auth/login|api/token)/ {
#         limit_req zone=login burst=3 nodelay;
#         limit_conn addr 3;
#         
#         include /etc/nginx/snippets/proxy-params.conf;
#         proxy_pass http://django_backend;
#     }
#     
#     # API endpoints
#     location /api/ {
#         limit_req zone=api burst=30 nodelay;
#         limit_conn addr 10;
#         
#         include /etc/nginx/snippets/proxy-params.conf;
#         proxy_pass http://django_backend;
#         
#         # CORS headers for API (adjust as needed)
#         add_header Access-Control-Allow-Origin "*" always;
#         add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
#         add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
#         
#         # Handle preflight requests
#         if ($request_method = OPTIONS) {
#             return 204;
#         }
#     }
#     
#     # WebSocket connections (for real-time features)
#     location /ws/ {
#         # Rate limiting for WebSocket connections
#         limit_req zone=general burst=10 nodelay;
#         limit_conn addr 5;
#         
#         include /etc/nginx/snippets/proxy-params.conf;
#         proxy_pass http://django_backend;
#         
#         # WebSocket specific configuration
#         include /etc/nginx/snippets/websocket.conf;
#     }
#     
#     # Prometheus metrics endpoint
#     location /metrics {
#         include /etc/nginx/snippets/proxy-params.conf;
#         proxy_pass http://django_backend;
#         
#         # Restrict access to monitoring systems
#         allow 127.0.0.1;
#         allow 172.16.0.0/12;  # Docker network
#         deny all;
#     }
#     
#     # Metrics and health check endpoints
#     include /etc/nginx/snippets/metrics.conf;
#     
#     # Default location - Proxy to Django
#     location / {
#         limit_req zone=general burst=20 nodelay;
#         limit_conn addr 10;
#         
#         include /etc/nginx/snippets/proxy-params.conf;
#         proxy_pass http://django_backend;
#     }
#     
#     # Deny access to hidden files
#     location ~ /\. {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }
#     
#     # Deny access to backup files
#     location ~ ~$ {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }
# }
