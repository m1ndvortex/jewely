<!-- Announcement Banner Component -->
<!-- This component displays active announcements as dismissible banners -->
<!-- Requirement 31.5: Display announcements as dismissible banners -->

<div id="announcement-banners" class="space-y-2">
    <!-- Banners will be loaded via HTMX -->
</div>

<script>
    // Load announcements on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAnnouncementBanners();
    });

    // Reload announcements every 5 minutes
    setInterval(loadAnnouncementBanners, 300000);

    function loadAnnouncementBanners() {
        fetch('{% url "core:api_tenant_active_announcements" %}')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('announcement-banners');
                container.innerHTML = '';

                if (data.announcements && data.announcements.length > 0) {
                    data.announcements.forEach(announcement => {
                        const banner = createAnnouncementBanner(announcement);
                        container.appendChild(banner);
                    });
                }

                // Update notification badge if exists
                const badge = document.getElementById('announcement-badge');
                if (badge && data.unread_count > 0) {
                    badge.textContent = data.unread_count;
                    badge.classList.remove('hidden');
                } else if (badge) {
                    badge.classList.add('hidden');
                }
            })
            .catch(error => console.error('Error loading announcements:', error));
    }

    function createAnnouncementBanner(announcement) {
        const banner = document.createElement('div');
        
        // Determine colors based on severity
        let borderColor, bgColor, textColor, iconColor;
        switch(announcement.severity) {
            case 'CRITICAL':
                borderColor = 'border-red-500';
                bgColor = 'bg-red-50 dark:bg-red-900/20';
                textColor = 'text-red-800 dark:text-red-200';
                iconColor = 'text-red-600 dark:text-red-400';
                break;
            case 'WARNING':
                borderColor = 'border-yellow-500';
                bgColor = 'bg-yellow-50 dark:bg-yellow-900/20';
                textColor = 'text-yellow-800 dark:text-yellow-200';
                iconColor = 'text-yellow-600 dark:text-yellow-400';
                break;
            case 'MAINTENANCE':
                borderColor = 'border-blue-500';
                bgColor = 'bg-blue-50 dark:bg-blue-900/20';
                textColor = 'text-blue-800 dark:text-blue-200';
                iconColor = 'text-blue-600 dark:text-blue-400';
                break;
            default:
                borderColor = 'border-green-500';
                bgColor = 'bg-green-50 dark:bg-green-900/20';
                textColor = 'text-green-800 dark:text-green-200';
                iconColor = 'text-green-600 dark:text-green-400';
        }

        banner.className = `border-l-4 ${borderColor} ${bgColor} p-4 mb-2 rounded-r-lg shadow-sm`;
        banner.setAttribute('data-announcement-id', announcement.id);

        let acknowledgeButton = '';
        if (announcement.requires_acknowledgment && !announcement.is_acknowledged) {
            acknowledgeButton = `
                <a href="/announcements/${announcement.id}/acknowledge/" 
                   class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 mr-2">
                    Acknowledge
                </a>
            `;
        }

        let dismissButton = '';
        if (announcement.is_dismissible) {
            dismissButton = `
                <button onclick="dismissAnnouncement('${announcement.id}')" 
                        class="inline-flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus:outline-none">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
        }

        banner.innerHTML = `
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-medium ${textColor}">
                        ${announcement.title}
                    </h3>
                    <div class="mt-1 text-sm ${textColor}">
                        <p>${announcement.message}</p>
                    </div>
                    <div class="mt-3 flex items-center space-x-2">
                        ${acknowledgeButton}
                        <a href="/announcements/${announcement.id}/" 
                           class="inline-flex items-center px-3 py-1 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md ${textColor} bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            View Details
                        </a>
                    </div>
                </div>
                <div class="ml-3 flex-shrink-0">
                    ${dismissButton}
                </div>
            </div>
        `;

        return banner;
    }

    function dismissAnnouncement(announcementId) {
        fetch(`/announcements/${announcementId}/dismiss/?next=${window.location.pathname}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(() => {
            // Remove banner from DOM
            const banner = document.querySelector(`[data-announcement-id="${announcementId}"]`);
            if (banner) {
                banner.style.transition = 'opacity 0.3s';
                banner.style.opacity = '0';
                setTimeout(() => banner.remove(), 300);
            }
            // Reload banners to update count
            setTimeout(loadAnnouncementBanners, 500);
        })
        .catch(error => console.error('Error dismissing announcement:', error));
    }
</script>
