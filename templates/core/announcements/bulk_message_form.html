{% extends "base.html" %}
{% load static %}

{% block title %}Send Bulk Message{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Send Bulk Message</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">
                Send a message to multiple tenants at once via email, SMS, or in-app notification.
            </p>
        </div>

        <!-- Form -->
        <form method="post" id="bulkMessageForm" class="space-y-6">
            {% csrf_token %}

            <!-- Template Selection -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">
                    Use Template (Optional)
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for template in templates %}
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 hover:border-indigo-500 cursor-pointer"
                         onclick="applyTemplate('{{ template.id }}', '{{ template.subject|escapejs }}', '{{ template.message|escapejs }}', {{ template.default_channels|safe }})">
                        <h3 class="font-semibold text-gray-900 dark:text-white">{{ template.name }}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ template.get_template_type_display }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">Used {{ template.usage_count }} times</p>
                    </div>
                    {% empty %}
                    <p class="text-gray-600 dark:text-gray-400 col-span-2">No templates available.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Message Content -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">
                    Message Content
                </h2>

                <div class="space-y-4">
                    <!-- Subject -->
                    <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Subject *
                        </label>
                        <input type="text" 
                               id="subject" 
                               name="subject" 
                               required
                               value="{{ request.session.bulk_message_template.subject|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white"
                               placeholder="Enter message subject">
                    </div>

                    <!-- Message -->
                    <div>
                        <label for="message" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Message *
                        </label>
                        <textarea id="message" 
                                  name="message" 
                                  required
                                  rows="8"
                                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white"
                                  placeholder="Enter message content">{{ request.session.bulk_message_template.message|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Delivery Channels -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">
                    Delivery Channels *
                </h2>

                <div class="space-y-3">
                    <label class="flex items-center">
                        <input type="checkbox" 
                               name="channel_email" 
                               value="1"
                               checked
                               class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <span class="ml-2 text-gray-700 dark:text-gray-300">Email</span>
                    </label>

                    <label class="flex items-center">
                        <input type="checkbox" 
                               name="channel_sms" 
                               value="1"
                               class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <span class="ml-2 text-gray-700 dark:text-gray-300">SMS</span>
                    </label>

                    <label class="flex items-center">
                        <input type="checkbox" 
                               name="channel_in_app" 
                               value="1"
                               checked
                               class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <span class="ml-2 text-gray-700 dark:text-gray-300">In-App Notification</span>
                    </label>
                </div>
            </div>

            <!-- Target Selection -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">
                    Target Tenants *
                </h2>

                <div class="space-y-4">
                    <!-- All Tenants -->
                    <label class="flex items-start">
                        <input type="radio" 
                               name="target_type" 
                               value="all"
                               checked
                               class="mt-1 w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                               onchange="updateTargetSelection('all')">
                        <div class="ml-3">
                            <span class="font-medium text-gray-900 dark:text-white">All Active Tenants</span>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Send to all active tenants on the platform</p>
                        </div>
                    </label>

                    <!-- By Plan -->
                    <label class="flex items-start">
                        <input type="radio" 
                               name="target_type" 
                               value="plan"
                               class="mt-1 w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                               onchange="updateTargetSelection('plan')">
                        <div class="ml-3 flex-1">
                            <span class="font-medium text-gray-900 dark:text-white">By Subscription Plan</span>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Send to tenants on a specific plan</p>
                            <select name="target_plan" 
                                    id="target_plan"
                                    disabled
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
                                <option value="">Select a plan...</option>
                                {% for plan in plans %}
                                <option value="{{ plan.name }}">{{ plan.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </label>

                    <!-- Specific Tenants -->
                    <label class="flex items-start">
                        <input type="radio" 
                               name="target_type" 
                               value="specific"
                               class="mt-1 w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                               onchange="updateTargetSelection('specific')">
                        <div class="ml-3 flex-1">
                            <span class="font-medium text-gray-900 dark:text-white">Specific Tenants</span>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Select individual tenants</p>
                            <div id="tenant_selection" 
                                 class="max-h-64 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-4 space-y-2"
                                 style="display: none;">
                                {% for tenant in tenants %}
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           name="tenant_ids" 
                                           value="{{ tenant.id }}"
                                           class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="ml-2 text-gray-700 dark:text-gray-300">{{ tenant.company_name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end space-x-4">
                <a href="{% url 'core:direct_message_list' %}" 
                   class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Send Bulk Message
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function updateTargetSelection(type) {
    const planSelect = document.getElementById('target_plan');
    const tenantSelection = document.getElementById('tenant_selection');
    
    if (type === 'plan') {
        planSelect.disabled = false;
        tenantSelection.style.display = 'none';
    } else if (type === 'specific') {
        planSelect.disabled = true;
        tenantSelection.style.display = 'block';
    } else {
        planSelect.disabled = true;
        tenantSelection.style.display = 'none';
    }
}

function applyTemplate(id, subject, message, channels) {
    document.getElementById('subject').value = subject;
    document.getElementById('message').value = message;
    
    // Update channel checkboxes
    document.querySelector('input[name="channel_email"]').checked = channels.includes('email');
    document.querySelector('input[name="channel_sms"]').checked = channels.includes('sms');
    document.querySelector('input[name="channel_in_app"]').checked = channels.includes('in_app');
}
</script>
{% endblock %}
