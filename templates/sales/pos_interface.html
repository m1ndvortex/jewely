{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Point of Sale" %} - Jewelry Shop{% endblock %}

{% block content %}
<script>
// Define posApp before Alpine.js initializes
function posApp() {
    return {
        // State
        searchQuery: '',
        searchResults: [],
        loading: false,
        cart: [],
        selectedCustomer: null,
        customerSearch: '',
        customerResults: [],
        selectedTerminalId: '{{terminals.0.id|default:""}}',
        selectedTerminal: null,
        paymentMethod: 'CASH',
        discount: 0,
        processing: false,
        showCustomerQuickAdd: false,
        newCustomer: {
            first_name: '',
            last_name: '',
            phone: '',
            email: ''
        },
        
        // Connection status
        isOnline: navigator.onLine,
        
        // Quick access state
        activeTab: 'favorites',
        favoriteProducts: [],
        recentTransactions: [],

        // Computed
        get subtotal() {
            return this.cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
        },
        get tax() {
            return this.subtotal * 0.10; // 10% tax
        },
        get total() {
            return this.subtotal + this.tax - this.discount;
        },

        // Initialize
        init() {
            console.log('[POS] Initializing POS system...');
            
            // Load initial data
            if (this.selectedTerminalId) {
                this.loadTerminal();
            }
            
            // Focus on search input
            this.$nextTick(() => {
                const searchInput = document.querySelector('input[type="text"]');
                if (searchInput) searchInput.focus();
            });
            
            // Listen for online/offline events
            window.addEventListener('online', () => {
                this.isOnline = true;
                console.log('[POS] Connection restored');
            });
            
            window.addEventListener('offline', () => {
                this.isOnline = false;
                console.log('[POS] Connection lost');
            });
        },

        async searchProducts() {
            if (!this.searchQuery.trim()) {
                this.searchResults = [];
                return;
            }

            this.loading = true;
            try {
                const response = await fetch(`/api/pos/search/products/?q=${encodeURIComponent(this.searchQuery)}`, {
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.searchResults = data.results || [];
                console.log('[POS] Found products:', this.searchResults.length);
            } catch (error) {
                console.error('[POS] Error searching products:', error);
                this.searchResults = [];
                if (error.message.includes('Failed to fetch')) {
                    alert('Network error. Please check your connection.');
                }
            } finally {
                this.loading = false;
            }
        },

        addToCart(product) {
            // Check if product already in cart
            const existingIndex = this.cart.findIndex(item => item.id === product.id);
            
            if (existingIndex >= 0) {
                // Increment quantity if already in cart
                const newQuantity = this.cart[existingIndex].quantity + 1;
                if (newQuantity <= product.quantity) {
                    this.cart[existingIndex].quantity = newQuantity;
                } else {
                    alert('Insufficient stock');
                }
            } else {
                // Add new item to cart
                this.cart.push({
                    id: product.id,
                    name: product.name,
                    sku: product.sku,
                    unit_price: parseFloat(product.selling_price),
                    quantity: 1,
                    available_quantity: product.quantity
                });
            }

            // Clear search
            this.searchQuery = '';
            this.searchResults = [];
        },

        removeFromCart(index) {
            this.cart.splice(index, 1);
        },

        updateQuantity(index, newQuantity) {
            if (newQuantity < 1) {
                this.removeFromCart(index);
                return;
            }

            if (newQuantity > this.cart[index].available_quantity) {
                alert('Insufficient stock');
                return;
            }

            this.cart[index].quantity = newQuantity;
        },

        clearCart() {
            if (confirm('Are you sure you want to clear the cart?')) {
                this.cart = [];
                this.selectedCustomer = null;
                this.discount = 0;
            }
        },

        async searchCustomers() {
            if (!this.customerSearch.trim()) {
                this.customerResults = [];
                return;
            }

            try {
                const response = await fetch(`/api/pos/search/customers/?q=${encodeURIComponent(this.customerSearch)}`, {
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.customerResults = data.results || [];
                console.log('[POS] Found customers:', this.customerResults.length);
            } catch (error) {
                console.error('[POS] Error searching customers:', error);
                this.customerResults = [];
            }
        },

        selectCustomer(customer) {
            this.selectedCustomer = customer;
            this.customerSearch = '';
            this.customerResults = [];
        },

        async quickAddCustomer() {
            try {
                const response = await fetch('/api/pos/customers/quick-add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(this.newCustomer)
                });

                if (response.ok) {
                    const customer = await response.json();
                    this.selectedCustomer = customer;
                    this.showCustomerQuickAdd = false;
                    // Reset form
                    this.newCustomer = {
                        first_name: '',
                        last_name: '',
                        phone: '',
                        email: ''
                    };
                } else {
                    const error = await response.json();
                    alert('Error adding customer: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('Error adding customer:', error);
                alert('Error adding customer');
            }
        },

        loadTerminal() {
            const terminals = [
                {% for terminal in terminals %}
                {
                    id: '{{ terminal.id }}',
                    terminal_id: '{{ terminal.terminal_id }}',
                    branch_name: '{{ terminal.branch.name }}'
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            this.selectedTerminal = terminals.find(t => t.id === this.selectedTerminalId);
        },

        async completeSale() {
            if (this.cart.length === 0) {
                alert('Cart is empty');
                return;
            }

            if (!this.selectedTerminalId) {
                alert('Please select a terminal');
                return;
            }

            this.processing = true;

            try {
                const saleData = {
                    customer_id: this.selectedCustomer?.id || null,
                    terminal_id: this.selectedTerminalId,
                    items: this.cart.map(item => ({
                        inventory_item_id: item.id,
                        quantity: item.quantity,
                        unit_price: item.unit_price.toString()
                    })),
                    payment_method: this.paymentMethod,
                    tax_rate: '10.00',
                    discount: this.discount.toString(),
                    status: 'COMPLETED'
                };

                const response = await fetch('/api/pos/sales/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(saleData)
                });

                if (response.ok) {
                    const sale = await response.json();
                    alert(`Sale completed successfully!\nSale Number: ${sale.sale_number}\nTotal: $${sale.total}`);
                    
                    // Reset cart
                    this.cart = [];
                    this.selectedCustomer = null;
                    this.discount = 0;
                    this.paymentMethod = 'CASH';
                } else {
                    const error = await response.json();
                    alert('Error completing sale: ' + (error.detail || JSON.stringify(error)));
                }
            } catch (error) {
                console.error('Error completing sale:', error);
                alert('Error completing sale. Please try again.');
            } finally {
                this.processing = false;
            }
        },

        async holdSale() {
            alert('Hold sale feature coming soon!');
        },

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
    }
}
</script>

<!-- Main POS Container -->
<div x-data="posApp()" x-init="init()" class="min-h-screen bg-gray-100 flex flex-col">
    {% csrf_token %}
    
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 px-8 py-6">
        <div class="max-w-[1600px] mx-auto">
            <div class="flex items-center justify-between">
                <!-- Left: Title and Welcome -->
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-1">Point of Sale</h1>
                    <p class="text-gray-500">Welcome, {{ user.get_full_name|default:user.username }}</p>
                </div>
                
                <!-- Right: Status Indicators -->
                <div class="flex items-center space-x-6">
                    <!-- Online Status -->
                    <div class="flex items-center space-x-2">
                        <div 
                            :class="isOnline ? 'bg-green-500' : 'bg-red-500'"
                            class="w-3 h-3 rounded-full"
                        ></div>
                        <span class="text-sm font-medium text-gray-700" x-text="isOnline ? 'Online' : 'Offline'"></span>
                    </div>
                    
                    <!-- Terminal Info -->
                    <div class="flex items-center space-x-2 px-4 py-2 bg-gray-50 rounded-lg">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <span class="text-sm font-medium text-gray-700" x-text="selectedTerminal ? selectedTerminal.terminal_id : 'Terminal 1'"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Panel: Product Search -->
        <div class="flex-1 bg-white p-8">
            <div class="max-w-3xl">
                <!-- Search Bar -->
                <div class="relative mb-6">
                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input 
                        type="text" 
                        x-model="searchQuery"
                        @input.debounce.300ms="searchProducts()"
                        @keydown.enter="searchProducts()"
                        placeholder="Search products by SKU, name, or scan barcode..."
                        class="w-full pl-12 pr-4 py-3 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        autofocus
                    >
                </div>

                <!-- Tabs -->
                <div x-show="!searchQuery" class="flex space-x-4 border-b border-gray-200 mb-6">
                    <button 
                        @click="activeTab = 'favorites'"
                        :class="activeTab === 'favorites' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="pb-3 px-1 border-b-2 font-medium transition-colors"
                    >
                        Favorites
                    </button>
                    <button 
                        @click="activeTab = 'recent'"
                        :class="activeTab === 'recent' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="pb-3 px-1 border-b-2 font-medium transition-colors"
                    >
                        Recent
                    </button>
                </div>

                <!-- Content Area -->
                <div>
                    <!-- Loading State -->
                    <div x-show="loading" class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent"></div>
                        <p class="mt-4 text-gray-600">Searching...</p>
                    </div>

                    <!-- Search Results -->
                    <div x-show="!loading && searchQuery && searchResults.length > 0" class="space-y-3">
                        <template x-for="product in searchResults" :key="product.id">
                            <div 
                                @click="addToCart(product)"
                                class="group p-4 bg-white border border-gray-200 rounded-lg hover:border-purple-300 hover:shadow-md cursor-pointer transition-all"
                            >
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-gray-900 group-hover:text-purple-600" x-text="product.name"></h3>
                                        <p class="text-sm text-gray-600 mt-1">
                                            SKU: <span x-text="product.sku"></span>
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            <span x-text="product.karat + 'K'"></span> • 
                                            <span x-text="product.weight_grams + 'g'"></span> •
                                            Stock: <span x-text="product.quantity"></span>
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold text-gray-900">
                                            $<span x-text="parseFloat(product.selling_price).toFixed(2)"></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- No Results -->
                    <div x-show="!loading && searchQuery && searchResults.length === 0" class="text-center py-12">
                        <svg class="mx-auto h-24 w-24 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                        </svg>
                        <p class="mt-4 text-gray-600 font-medium">No products found</p>
                        <p class="text-sm text-gray-500 mt-1">Try a different search term</p>
                    </div>

                    <!-- Favorites Tab -->
                    <div x-show="!loading && !searchQuery && activeTab === 'favorites'" class="text-center py-12">
                        <svg class="mx-auto h-24 w-24 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                        </svg>
                        <p class="mt-4 text-gray-600 font-medium">No favorite products yet</p>
                        <p class="text-sm text-gray-500 mt-1">Products will appear here based on sales frequency</p>
                    </div>

                    <!-- Recent Tab -->
                    <div x-show="!loading && !searchQuery && activeTab === 'recent'" class="text-center py-12">
                        <svg class="mx-auto h-24 w-24 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="mt-4 text-gray-600 font-medium">No recent transactions</p>
                        <p class="text-sm text-gray-500 mt-1">Your recent sales will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Cart & Checkout -->
        <div class="w-[480px] bg-white border-l border-gray-200 flex flex-col">
            <!-- Cart Header -->
            <div class="px-8 py-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">
                    Cart (<span x-text="cart.length"></span>)
                </h2>
            </div>

            <!-- Cart Items Area -->
            <div class="flex-1 overflow-y-auto px-8 py-6">
                <!-- Empty Cart -->
                <div x-show="cart.length === 0" class="text-center py-16">
                    <svg class="mx-auto h-24 w-24 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <p class="mt-4 text-gray-600 font-medium">Your cart is empty</p>
                    <p class="text-sm text-gray-500 mt-1">Add products to get started</p>
                </div>

                <!-- Cart Items -->
                <div x-show="cart.length > 0" class="space-y-3">
                    <template x-for="(item, index) in cart" :key="index">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900" x-text="item.name"></h4>
                                    <p class="text-sm text-gray-600" x-text="'SKU: ' + item.sku"></p>
                                </div>
                                <button 
                                    @click="removeFromCart(index)"
                                    class="text-gray-400 hover:text-red-600"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <button 
                                        @click="updateQuantity(index, item.quantity - 1)"
                                        class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                                        </svg>
                                    </button>
                                    <input 
                                        type="number" 
                                        x-model.number="item.quantity"
                                        @change="updateQuantity(index, item.quantity)"
                                        min="1"
                                        :max="item.available_quantity"
                                        class="w-16 text-center border border-gray-300 rounded py-1.5 text-sm font-medium"
                                    >
                                    <button 
                                        @click="updateQuantity(index, item.quantity + 1)"
                                        class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">
                                        $<span x-text="parseFloat(item.unit_price).toFixed(2)"></span> each
                                    </p>
                                    <p class="font-bold text-gray-900">
                                        $<span x-text="(item.unit_price * item.quantity).toFixed(2)"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Checkout Section -->
            <div class="px-8 py-6 border-t border-gray-200 space-y-6">
                <!-- Customer Selection -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Customer (Optional)
                    </label>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <input 
                            type="text" 
                            x-model="customerSearch"
                            @input.debounce.300ms="searchCustomers()"
                            placeholder="Search customer..."
                            class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                    </div>
                    
                    <!-- Customer Search Results Dropdown -->
                    <div x-show="customerResults.length > 0" class="mt-2 border border-gray-200 rounded-lg max-h-40 overflow-y-auto shadow-lg">
                        <template x-for="customer in customerResults" :key="customer.id">
                            <div 
                                @click="selectCustomer(customer)"
                                class="p-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                            >
                                <p class="font-medium text-sm text-gray-900" x-text="customer.full_name"></p>
                                <p class="text-xs text-gray-600" x-text="customer.phone"></p>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Selected Customer Display -->
                    <div x-show="selectedCustomer" class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-medium text-sm text-gray-900" x-text="selectedCustomer?.full_name"></p>
                            <p class="text-xs text-gray-600" x-text="selectedCustomer?.phone"></p>
                        </div>
                        <button @click="selectedCustomer = null; customerSearch = ''" class="text-gray-400 hover:text-red-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Terminal Selection -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Terminal
                    </label>
                    <select 
                        x-model="selectedTerminalId"
                        @change="loadTerminal()"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    >
                        <option value="">Select Terminal</option>
                        {% for terminal in terminals %}
                        <option value="{{ terminal.id }}">{{ terminal.terminal_id }} - {{ terminal.branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Payment Method -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        Payment Method
                    </label>
                    <div class="grid grid-cols-3 gap-3">
                        <button 
                            @click="paymentMethod = 'CASH'"
                            :class="paymentMethod === 'CASH' ? 'bg-purple-500 text-white border-purple-500' : 'bg-white text-gray-700 border-gray-300'"
                            class="py-3 px-4 rounded-lg border-2 hover:border-purple-400 transition-all font-medium"
                        >
                            <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            <span class="block text-sm">Cash</span>
                        </button>
                        <button 
                            @click="paymentMethod = 'CARD'"
                            :class="paymentMethod === 'CARD' ? 'bg-purple-500 text-white border-purple-500' : 'bg-white text-gray-700 border-gray-300'"
                            class="py-3 px-4 rounded-lg border-2 hover:border-purple-400 transition-all font-medium"
                        >
                            <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                            </svg>
                            <span class="block text-sm">Card</span>
                        </button>
                        <button 
                            @click="paymentMethod = 'STORE_CREDIT'"
                            :class="paymentMethod === 'STORE_CREDIT' ? 'bg-purple-500 text-white border-purple-500' : 'bg-white text-gray-700 border-gray-300'"
                            class="py-3 px-4 rounded-lg border-2 hover:border-purple-400 transition-all font-medium"
                        >
                            <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="block text-sm">Credit</span>
                        </button>
                    </div>
                </div>

                <!-- Totals -->
                <div class="space-y-3 pt-4 border-t border-gray-200">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Subtotal</span>
                        <span class="font-semibold text-gray-900">$<span x-text="subtotal.toFixed(2)"></span></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Tax (10%)</span>
                        <span class="font-semibold text-gray-900">$<span x-text="tax.toFixed(2)"></span></span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">Discount</span>
                        <input 
                            type="number" 
                            x-model.number="discount"
                            min="0"
                            :max="subtotal"
                            step="0.01"
                            placeholder="0"
                            class="w-24 text-right px-3 py-1.5 border border-gray-300 rounded-lg text-sm font-semibold"
                        >
                    </div>
                    <div class="flex justify-between text-2xl font-bold pt-3 border-t border-gray-300">
                        <span class="text-gray-900">Total</span>
                        <span class="text-gray-900">$<span x-text="total.toFixed(2)"></span></span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-3">
                    <button 
                        @click="holdSale()"
                        :disabled="cart.length === 0"
                        class="py-3 px-4 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed font-semibold transition-colors flex items-center justify-center"
                    >
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Hold
                    </button>
                    <button 
                        @click="completeSale()"
                        :disabled="cart.length === 0 || !selectedTerminalId || processing"
                        class="py-3 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed font-semibold transition-colors flex items-center justify-center"
                    >
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span x-text="processing ? 'Processing...' : 'Complete Sale'"></span>
                    </button>
                </div>

                <!-- Additional Actions -->
                <div class="grid grid-cols-2 gap-3">
                    <button 
                        class="py-2.5 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium transition-colors text-sm flex items-center justify-center"
                    >
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Reprint Receipt
                    </button>
                    <button 
                        class="py-2.5 px-4 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-medium transition-colors text-sm flex items-center justify-center"
                    >
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Held Sales
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
[x-cloak] {
    display: none !important;
}
</style>
{% endblock %}
