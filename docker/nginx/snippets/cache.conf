# Cache Control and ETag Configuration
# Optimizes static asset delivery with proper caching headers
# Requirement 22: Nginx Configuration - Set cache headers and generate ETags

# Enable ETags for cache validation
# ETags allow browsers to validate cached content without re-downloading
# Nginx generates ETags based on file modification time and size
etag on;

# If-Modified-Since header handling
# Allows conditional requests based on Last-Modified header
if_modified_since before;

# Open file cache for improved performance
# Caches file descriptors, sizes, and modification times
open_file_cache max=10000 inactive=30s;
open_file_cache_valid 60s;
open_file_cache_min_uses 2;
open_file_cache_errors on;

# Cache configuration for different file types
# These are applied in location blocks using map or directly

# Static assets cache map (use in location blocks)
# Example usage: expires $expires_map;
map $sent_http_content_type $expires_map {
    default                    off;
    
    # HTML - Short cache (1 hour) for dynamic content
    text/html                  1h;
    
    # CSS and JavaScript - Medium cache (1 day)
    # These change more frequently than images
    text/css                   1d;
    text/javascript            1d;
    application/javascript     1d;
    application/x-javascript   1d;
    
    # Images - Long cache (30 days)
    # Images rarely change
    image/gif                  30d;
    image/jpeg                 30d;
    image/jpg                  30d;
    image/png                  30d;
    image/svg+xml              30d;
    image/x-icon               30d;
    image/webp                 30d;
    
    # Fonts - Very long cache (1 year)
    # Fonts almost never change
    font/woff                  365d;
    font/woff2                 365d;
    font/ttf                   365d;
    font/eot                   365d;
    font/otf                   365d;
    application/font-woff      365d;
    application/font-woff2     365d;
    application/x-font-ttf     365d;
    application/x-font-truetype 365d;
    application/x-font-opentype 365d;
    application/vnd.ms-fontobject 365d;
    
    # Media files - Long cache (30 days)
    audio/mpeg                 30d;
    audio/ogg                  30d;
    audio/wav                  30d;
    video/mp4                  30d;
    video/mpeg                 30d;
    video/webm                 30d;
    
    # Documents - Medium cache (7 days)
    application/pdf            7d;
    application/msword         7d;
    application/vnd.ms-excel   7d;
    application/vnd.ms-powerpoint 7d;
    
    # JSON and XML - Short cache (1 hour)
    application/json           1h;
    application/xml            1h;
    text/xml                   1h;
}

# Cache-Control header directives
# public: Can be cached by any cache (browser, CDN, proxy)
# private: Can only be cached by browser
# no-cache: Must revalidate with server before using cached version
# no-store: Must not be cached at all
# immutable: Content will never change (use with versioned assets)
# max-age: Maximum time to cache in seconds
# s-maxage: Maximum time for shared caches (CDN, proxy)
