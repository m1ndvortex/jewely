{% extends "procurement/base.html" %}
{% load static %}

{% block title %}Purchase Orders{% endblock %}

{% block main_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Purchase Orders</h1>
                <a href="{% url 'procurement:purchase_order_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create Purchase Order
                </a>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search_query }}" placeholder="PO number, supplier...">
                        </div>
                        <div class="col-md-2">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Statuses</option>
                                {% for value, label in status_choices %}
                                    <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="priority" class="form-label">Priority</label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="">All Priorities</option>
                                {% for value, label in priority_choices %}
                                    <option value="{{ value }}" {% if priority_filter == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="supplier" class="form-label">Supplier</label>
                            <select class="form-select" id="supplier" name="supplier">
                                <option value="">All Suppliers</option>
                                {% for supplier in suppliers %}
                                    <option value="{{ supplier.id }}" {% if supplier_filter == supplier.id|stringformat:"s" %}selected{% endif %}>
                                        {{ supplier.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-outline-primary me-2">Filter</button>
                            <a href="{% url 'procurement:purchase_order_list' %}" class="btn btn-outline-secondary">Clear</a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Purchase Orders Table -->
            <div class="card">
                <div class="card-body">
                    {% if purchase_orders %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>PO Number</th>
                                        <th>Supplier</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Total Amount</th>
                                        <th>Order Date</th>
                                        <th>Expected Delivery</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for po in purchase_orders %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'procurement:purchase_order_detail' po.pk %}" class="text-decoration-none">
                                                    <strong>{{ po.po_number }}</strong>
                                                </a>
                                            </td>
                                            <td>{{ po.supplier.name }}</td>
                                            <td>
                                                {% if po.status == 'DRAFT' %}
                                                    <span class="badge bg-secondary">{{ po.get_status_display }}</span>
                                                {% elif po.status == 'APPROVED' %}
                                                    <span class="badge bg-success">{{ po.get_status_display }}</span>
                                                {% elif po.status == 'SENT' %}
                                                    <span class="badge bg-info">{{ po.get_status_display }}</span>
                                                {% elif po.status == 'PARTIALLY_RECEIVED' %}
                                                    <span class="badge bg-warning">{{ po.get_status_display }}</span>
                                                {% elif po.status == 'COMPLETED' %}
                                                    <span class="badge bg-primary">{{ po.get_status_display }}</span>
                                                {% elif po.status == 'CANCELLED' %}
                                                    <span class="badge bg-danger">{{ po.get_status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if po.priority == 'URGENT' %}
                                                    <span class="badge bg-danger">{{ po.get_priority_display }}</span>
                                                {% elif po.priority == 'HIGH' %}
                                                    <span class="badge bg-warning">{{ po.get_priority_display }}</span>
                                                {% elif po.priority == 'NORMAL' %}
                                                    <span class="badge bg-info">{{ po.get_priority_display }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ po.get_priority_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>${{ po.total_amount|floatformat:2 }}</td>
                                            <td>{{ po.order_date }}</td>
                                            <td>{{ po.expected_delivery|default:"TBD" }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="{% url 'procurement:purchase_order_detail' po.pk %}" 
                                                       class="btn btn-outline-primary" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% if po.status == 'DRAFT' %}
                                                        <a href="{% url 'procurement:purchase_order_edit' po.pk %}" 
                                                           class="btn btn-outline-secondary" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if is_paginated %}
                            <nav aria-label="Purchase orders pagination">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if supplier_filter %}&supplier={{ supplier_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">First</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if supplier_filter %}&supplier={{ supplier_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">Previous</a>
                                        </li>
                                    {% endif %}

                                    <li class="page-item active">
                                        <span class="page-link">
                                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                        </span>
                                    </li>

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if supplier_filter %}&supplier={{ supplier_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">Next</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if supplier_filter %}&supplier={{ supplier_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">Last</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Purchase Orders Found</h5>
                            <p class="text-muted">
                                {% if search_query or status_filter or supplier_filter or priority_filter %}
                                    No purchase orders match your current filters.
                                {% else %}
                                    You haven't created any purchase orders yet.
                                {% endif %}
                            </p>
                            <a href="{% url 'procurement:purchase_order_create' %}" class="btn btn-primary">
                                Create Your First Purchase Order
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}