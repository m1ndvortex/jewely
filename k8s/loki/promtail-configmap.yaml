apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: jewelry-shop
  labels:
    app: promtail
    component: logging
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0
      log_level: info

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://loki:3100/loki/api/v1/push
        backoff_config:
          min_period: 100ms
          max_period: 10s
          max_retries: 10
        timeout: 10s

    scrape_configs:
      # Scrape logs from all pods in the jewelry-shop namespace
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - jewelry-shop
        
        pipeline_stages:
          - cri: {}  # Parse CRI format logs
          - multiline:
              firstline: '^\d{4}-\d{2}-\d{2}'
              max_wait_time: 3s
          - regex:
              expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})'
          - timestamp:
              source: timestamp
              format: '2006-01-02 15:04:05'
          - labels:
              timestamp:
        
        relabel_configs:
          # Add namespace label
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          
          # Add pod name label
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          
          # Add container name label
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
          
          # Add app label
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          
          # Add component label
          - source_labels: [__meta_kubernetes_pod_label_component]
            target_label: component
          
          # Add node name label
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node
          
          # Drop logs from promtail itself to avoid recursion
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: promtail
            action: drop
          
          # Set the log path (k3d uses containerd, not docker)
          - replacement: /var/log/pods/*$1/*/*.log
            separator: /
            source_labels:
            - __meta_kubernetes_pod_namespace
            - __meta_kubernetes_pod_name
            - __meta_kubernetes_pod_container_name
            target_label: __path__

      # Scrape Django application logs specifically
      - job_name: django-app
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - jewelry-shop
        
        pipeline_stages:
          - cri: {}
          - json:
              expressions:
                level: level
                logger: logger
                message: message
                timestamp: timestamp
          - labels:
              level:
              logger:
          - timestamp:
              source: timestamp
              format: RFC3339
        
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: django
            action: keep
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
          - source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/*.log

      # Scrape Celery worker logs
      - job_name: celery-workers
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - jewelry-shop
        
        pipeline_stages:
          - cri: {}
          - regex:
              expression: '^\[(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}),\d+: (?P<level>\w+)/(?P<worker>[\w-]+)\] (?P<message>.*)'
          - labels:
              level:
              worker:
          - timestamp:
              source: timestamp
              format: '2006-01-02 15:04:05'
        
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: celery.*
            action: keep
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
          - source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/*.log

      # Scrape Nginx logs
      - job_name: nginx
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - jewelry-shop
        
        pipeline_stages:
          - cri: {}
          - regex:
              expression: '^(?P<remote_addr>[\w\.]+) - (?P<remote_user>[\w-]+) \[(?P<timestamp>.*?)\] "(?P<method>\w+) (?P<path>.*?) (?P<protocol>.*?)" (?P<status>\d+) (?P<body_bytes_sent>\d+) "(?P<http_referer>.*?)" "(?P<http_user_agent>.*?)"'
          - labels:
              method:
              status:
          - timestamp:
              source: timestamp
              format: '02/Jan/2006:15:04:05 -0700'
        
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: nginx
            action: keep
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
          - source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/*.log

      # Scrape PostgreSQL logs
      - job_name: postgresql
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - jewelry-shop
        
        pipeline_stages:
          - cri: {}
          - regex:
              expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d+) \w+ \[(?P<pid>\d+)\] (?P<level>\w+):  (?P<message>.*)'
          - labels:
              level:
          - timestamp:
              source: timestamp
              format: '2006-01-02 15:04:05.000'
        
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_application]
            regex: spilo
            action: keep
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
          - source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/*.log

      # Scrape Redis logs
      - job_name: redis
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - jewelry-shop
        
        pipeline_stages:
          - cri: {}
          - regex:
              expression: '^(?P<pid>\d+):(?P<role>\w+) (?P<timestamp>\d+ \w+ \d{4} \d{2}:\d{2}:\d{2}\.\d+) (?P<level>[\*\#\-\.]) (?P<message>.*)'
          - labels:
              level:
              role:
          - timestamp:
              source: timestamp
              format: '02 Jan 2006 15:04:05.000'
        
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: redis
            action: keep
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
          - source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/*.log
