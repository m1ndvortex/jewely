{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" 
      dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}" 
      data-theme="{% if user.is_authenticated %}{{ user.theme }}{% else %}light{% endif %}"
      class="{% if user.is_authenticated and user.theme == 'dark' %}dark{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% trans "Jewelry Shop" %}{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="dark"]'],
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#2563eb',
                            hover: '#1d4ed8',
                            light: '#dbeafe',
                            dark: '#1e40af',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Theme CSS (Light and Dark Mode) -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">
    
    <!-- RTL CSS Support -->
    <link rel="stylesheet" href="{% static 'css/rtl.css' %}">
    
    <!-- HTMX for dynamic interactions -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    
    <!-- Set up Alpine.js initialization listener and load Alpine.js with defer -->
    <script>
        // This runs immediately, before Alpine loads
        window.deferredAlpineInit = [];
        document.addEventListener('alpine:init', () => {
            // Run deferred initialization when Alpine starts
            window.deferredAlpineInit.forEach(fn => fn());
        });
    </script>
    
    <!-- Alpine.js for reactive components -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <!-- Persian font for RTL support -->
    {% if LANGUAGE_CODE == 'fa' %}
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <style>
        @font-face {
            font-family: 'Vazir';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazir';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir-Bold.woff2') format('woff2');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        body {
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
        }
    </style>
    {% endif %}
    
    <!-- Page-specific CSS -->
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <!-- Impersonation Banner -->
    {% load hijack %}
    {% if request.user.is_hijacked %}
    <div class="bg-purple-600 text-white px-4 py-3 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <div>
                    <p class="font-semibold">
                        {% blocktrans with username=request.user.username %}Impersonating: {{ username }}{% endblocktrans %}
                        {% if request.user.tenant %}
                        ({{ request.user.tenant.company_name }})
                        {% endif %}
                    </p>
                    <p class="text-sm text-purple-200">
                        {% trans "You are viewing this account as a platform administrator. All actions are logged." %}
                    </p>
                </div>
            </div>
            <form method="post" action="{% url 'hijack:release' %}" class="inline">
                {% csrf_token %}
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-white rounded-md shadow-sm text-sm font-medium text-white bg-purple-700 hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    {% trans "Stop Impersonating" %}
                </button>
            </form>
        </div>
    </div>
    {% endif %}
    
    {% if user.is_authenticated %}
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">
                            {% if user.role == 'PLATFORM_ADMIN' %}
                                {% trans "Platform Admin" %}
                            {% else %}
                                {% trans "Jewelry Shop" %}
                            {% endif %}
                        </h1>
                    </div>
                    
                    {% if user.role == 'PLATFORM_ADMIN' %}
                    <!-- Platform Admin Navigation -->
                    <div class="hidden md:ml-6 md:flex md:space-x-8">
                        <a href="{% url 'core:admin_dashboard' %}" class="{% if request.resolver_match.url_name == 'admin_dashboard' %}text-blue-600 dark:text-blue-400{% else %}text-gray-500 dark:text-gray-400{% endif %} hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium">
                            {% trans "Dashboard" %}
                        </a>
                        <a href="{% url 'core:admin_tenant_list' %}" class="{% if 'tenant' in request.resolver_match.url_name %}text-blue-600 dark:text-blue-400{% else %}text-gray-500 dark:text-gray-400{% endif %} hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium">
                            {% trans "Tenants" %}
                        </a>
                        <a href="{% url 'core:admin_subscription_plan_list' %}" class="{% if 'subscription' in request.resolver_match.url_name %}text-blue-600 dark:text-blue-400{% else %}text-gray-500 dark:text-gray-400{% endif %} hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium">
                            {% trans "Subscriptions" %}
                        </a>
                        <a href="{% url 'core:monitoring_dashboard' %}" class="{% if 'monitoring' in request.resolver_match.url_name %}text-blue-600 dark:text-blue-400{% else %}text-gray-500 dark:text-gray-400{% endif %} hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium">
                            {% trans "Monitoring" %}
                        </a>
                        <a href="{% url 'core:audit_log_explorer' %}" class="{% if 'audit' in request.resolver_match.url_name %}text-blue-600 dark:text-blue-400{% else %}text-gray-500 dark:text-gray-400{% endif %} hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium">
                            {% trans "Audit Logs" %}
                        </a>
                        <!-- More dropdown for additional admin features -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium inline-flex items-center">
                                {% trans "More" %}
                                <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div x-show="open" 
                                 @click.away="open = false"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="transform opacity-0 scale-95"
                                 x-transition:enter-end="transform opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="transform opacity-100 scale-100"
                                 x-transition:leave-end="transform opacity-0 scale-95"
                                 class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-50"
                                 style="display: none;">
                                <div class="py-1">
                                    <a href="{% url 'backups:dashboard' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Backups" %}</a>
                                    <a href="{% url 'core:security_dashboard' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Security" %}</a>
                                    <a href="{% url 'core:feature_flag_list' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Feature Flags" %}</a>
                                    <a href="{% url 'core:announcement_list' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Announcements" %}</a>
                                    <!-- Webhooks, Jobs, Documentation apps not yet implemented -->
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Tenant Navigation -->
                    <div class="hidden md:ml-6 md:flex md:space-x-8">
                        <a href="{% url 'core:tenant_dashboard' %}" class="{% if request.resolver_match.url_name == 'tenant_dashboard' %}text-blue-600 dark:text-blue-400{% else %}text-gray-500 dark:text-gray-400{% endif %} hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium">
                            {% trans "Dashboard" %}
                        </a>
                        <a href="{% url 'inventory:inventory_list' %}" class="{% if 'inventory' in request.resolver_match.app_name %}text-blue-600 dark:text-blue-400{% else %}text-gray-500 dark:text-gray-400{% endif %} hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium">
                            {% trans "Inventory" %}
                        </a>
                        <a href="{% url 'sales:pos_interface' %}" class="{% if 'sales' in request.resolver_match.app_name %}text-blue-600 dark:text-blue-400{% else %}text-gray-500 dark:text-gray-400{% endif %} hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium">
                            {% trans "POS" %}
                        </a>
                        <a href="{% url 'crm:customer_list' %}" class="{% if 'crm' in request.resolver_match.app_name %}text-blue-600 dark:text-blue-400{% else %}text-gray-500 dark:text-gray-400{% endif %} hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium">
                            {% trans "Customers" %}
                        </a>
                        <!-- More dropdown for additional tenant features -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 px-3 py-2 text-sm font-medium inline-flex items-center">
                                {% trans "More" %}
                                <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div x-show="open" 
                                 @click.away="open = false"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="transform opacity-0 scale-95"
                                 x-transition:enter-end="transform opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="transform opacity-100 scale-100"
                                 x-transition:leave-end="transform opacity-0 scale-95"
                                 class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-50"
                                 style="display: none;">
                                <div class="py-1">
                                    <a href="{% url 'accounting:dashboard' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Accounting" %}</a>
                                    <a href="{% url 'repair:repair_list' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Repairs" %}</a>
                                    <a href="{% url 'procurement:supplier_list' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Procurement" %}</a>
                                    <a href="{% url 'core:branch_list' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Branches" %}</a>
                                    <a href="{% url 'reporting:report_list' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Reports" %}</a>
                                    <a href="{% url 'core:settings_overview' %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{% trans "Settings" %}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" 
                            class="theme-toggle p-2 text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-md"
                            title="Toggle theme">
                        <!-- Sun icon (shown in dark mode) -->
                        <svg class="icon-sun h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <!-- Moon icon (shown in light mode) -->
                        <svg class="icon-moon h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </button>
                    
                    <!-- Language Switcher -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" 
                                class="flex items-center space-x-2 p-2 text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-md">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                            </svg>
                            <span class="text-sm font-medium">
                                {% if LANGUAGE_CODE == 'fa' %}فارسی{% else %}EN{% endif %}
                            </span>
                        </button>
                        
                        <!-- Language Dropdown -->
                        <div x-show="open" 
                             @click.away="open = false"
                             x-transition:enter="transition ease-out duration-100"
                             x-transition:enter-start="transform opacity-0 scale-95"
                             x-transition:enter-end="transform opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75"
                             x-transition:leave-start="transform opacity-100 scale-100"
                             x-transition:leave-end="transform opacity-0 scale-95"
                             class="absolute {% if LANGUAGE_BIDI %}left-0{% else %}right-0{% endif %} mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50"
                             style="display: none;">
                            <div class="py-1">
                                <button onclick="switchLanguage('en'); open = false;" 
                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-between">
                                    <span>English</span>
                                    {% if LANGUAGE_CODE == 'en' %}
                                    <svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    {% endif %}
                                </button>
                                <button onclick="switchLanguage('fa'); open = false;" 
                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-between">
                                    <span>فارسی (Persian)</span>
                                    {% if LANGUAGE_CODE == 'fa' %}
                                    <svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Bell -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" 
                                class="relative p-2 text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <span class="sr-only">{% trans "View notifications" %}</span>
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM9 7H4l5-5v5zm6 10V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2h6a2 2 0 002-2z"></path>
                            </svg>
                            <!-- Unread count badge -->
                            <div id="notification-count" 
                                 hx-get="{% url 'notifications:count' %}" 
                                 hx-trigger="load, refresh from:body"
                                 class="absolute -top-1 -right-1">
                                <!-- Badge will be loaded here -->
                            </div>
                        </button>
                        
                        <!-- Notification Dropdown -->
                        <div x-show="open" 
                             @click.away="open = false"
                             x-transition:enter="transition ease-out duration-100"
                             x-transition:enter-start="transform opacity-0 scale-95"
                             x-transition:enter-end="transform opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75"
                             x-transition:leave-start="transform opacity-100 scale-100"
                             x-transition:leave-end="transform opacity-0 scale-95"
                             id="notification-dropdown"
                             hx-get="{% url 'notifications:dropdown' %}"
                             hx-trigger="load, refresh from:body"
                             style="display: none;">
                            <!-- Dropdown content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" 
                                class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <span class="sr-only">{% trans "Open user menu" %}</span>
                            <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center">
                                <span class="text-sm font-medium text-white">
                                    {{ user.first_name.0|default:user.username.0|upper }}
                                </span>
                            </div>
                        </button>
                        
                        <div x-show="open" 
                             @click.away="open = false"
                             x-transition:enter="transition ease-out duration-100"
                             x-transition:enter-start="transform opacity-0 scale-95"
                             x-transition:enter-end="transform opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75"
                             x-transition:leave-start="transform opacity-100 scale-100"
                             x-transition:leave-end="transform opacity-0 scale-95"
                             class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50"
                             style="display: none;">
                            <div class="py-1">
                                <a href="{% url 'notifications:center' %}" 
                                   class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    {% trans "Notifications" %}
                                </a>
                                <a href="{% url 'notifications:preferences' %}" 
                                   class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    {% trans "Notification Settings" %}
                                </a>
                                <a href="/profile/" 
                                   class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    {% trans "Profile" %}
                                </a>
                                <a href="{% if user.is_platform_admin %}{% url 'core:admin_logout' %}{% else %}{% url 'core:tenant_logout' %}{% endif %}" 
                                   class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    {% trans "Sign out" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}
    
    <!-- Django Messages -->
    {% if messages %}
    <div class="fixed top-20 right-4 z-50 space-y-3" x-data="{ messages: [] }" x-init="
        // Initialize messages from Django
        {% for message in messages %}
        messages.push({
            id: '{{ forloop.counter }}',
            type: '{{ message.tags }}',
            text: '{{ message|escapejs }}',
            show: true
        });
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const index = messages.findIndex(m => m.id === '{{ forloop.counter }}');
            if (index !== -1) messages[index].show = false;
        }, 5000);
        {% endfor %}
    ">
        <template x-for="message in messages" :key="message.id">
            <div x-show="message.show"
                 x-transition:enter="transform ease-out duration-300 transition"
                 x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
                 x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
                 x-transition:leave="transition ease-in duration-100"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 :class="{
                     'bg-green-50 dark:bg-green-900/20 border-green-400 dark:border-green-700': message.type.includes('success'),
                     'bg-blue-50 dark:bg-blue-900/20 border-blue-400 dark:border-blue-700': message.type.includes('info'),
                     'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-400 dark:border-yellow-700': message.type.includes('warning'),
                     'bg-red-50 dark:bg-red-900/20 border-red-400 dark:border-red-700': message.type.includes('error') || message.type.includes('danger')
                 }"
                 class="max-w-sm w-full shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden border-l-4">
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <!-- Success Icon -->
                            <svg x-show="message.type.includes('success')" class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <!-- Info Icon -->
                            <svg x-show="message.type.includes('info')" class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <!-- Warning Icon -->
                            <svg x-show="message.type.includes('warning')" class="h-6 w-6 text-yellow-600 dark:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <!-- Error Icon -->
                            <svg x-show="message.type.includes('error') || message.type.includes('danger')" class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p :class="{
                                'text-green-800 dark:text-green-200': message.type.includes('success'),
                                'text-blue-800 dark:text-blue-200': message.type.includes('info'),
                                'text-yellow-800 dark:text-yellow-200': message.type.includes('warning'),
                                'text-red-800 dark:text-red-200': message.type.includes('error') || message.type.includes('danger')
                            }" class="text-sm font-medium" x-text="message.text"></p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button @click="message.show = false" 
                                    :class="{
                                        'text-green-600 hover:text-green-700 dark:text-green-400': message.type.includes('success'),
                                        'text-blue-600 hover:text-blue-700 dark:text-blue-400': message.type.includes('info'),
                                        'text-yellow-600 hover:text-yellow-700 dark:text-yellow-400': message.type.includes('warning'),
                                        'text-red-600 hover:text-red-700 dark:text-red-400': message.type.includes('error') || message.type.includes('danger')
                                    }"
                                    class="inline-flex rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2">
                                <span class="sr-only">Close</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
    {% endif %}
    
    {% block content %}
    {% endblock %}
    
    <!-- Auto-refresh notifications every 30 seconds -->
    <script>
        // Auto-refresh notification count and dropdown every 30 seconds
        setInterval(function() {
            if (document.getElementById('notification-count')) {
                htmx.trigger('#notification-count', 'refresh');
            }
            if (document.getElementById('notification-dropdown')) {
                htmx.trigger('#notification-dropdown', 'refresh');
            }
        }, 30000);
        
        // Theme toggle function
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            // Update the DOM immediately for instant feedback
            html.setAttribute('data-theme', newTheme);
            
            // Toggle dark class for Tailwind
            if (newTheme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             document.querySelector('meta[name="csrf-token"]')?.content ||
                             getCookie('csrftoken');
            
            // Send theme switch request to save preference
            fetch('{% url "core:theme_switch" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ theme: newTheme })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Theme switch error:', data.error);
                    // Revert on error
                    html.setAttribute('data-theme', currentTheme);
                    if (currentTheme === 'dark') {
                        html.classList.add('dark');
                    } else {
                        html.classList.remove('dark');
                    }
                }
            })
            .catch(error => {
                console.error('Theme switch error:', error);
                // Revert on error
                html.setAttribute('data-theme', currentTheme);
                if (currentTheme === 'dark') {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
            });
        }
        
        // Language switcher function
        function switchLanguage(language) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             document.querySelector('meta[name="csrf-token"]')?.content ||
                             getCookie('csrftoken');
            
            // Send language switch request
            fetch('{% url "core:language_switch" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ language: language })
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Language switch failed with status:', response.status);
                    return response.text().then(text => {
                        console.error('Response body:', text.substring(0, 500));
                        throw new Error(`HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.message) {
                    // Reload page to apply new language
                    window.location.reload();
                } else if (data.error) {
                    console.error('Language switch error:', data.error);
                    alert('Failed to switch language: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Language switch error:', error);
                alert('Failed to switch language. Please try again.');
            });
        }
        
        // Helper function to get cookie value
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    
    <!-- Alpine.js component registration -->
    {% block alpine_components %}{% endblock %}
    
    <!-- Page-specific JavaScript -->
    {% block extra_js %}{% endblock %}
</body>
</html>