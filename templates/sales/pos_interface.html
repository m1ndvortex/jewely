{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Point of Sale" %} - Jewelry Shop{% endblock %}

{% block content %}
<script>
// Define posApp before Alpine.js initializes
function posApp() {
    return {
        // State
        searchQuery: '',
        searchResults: [],
        loading: false,
        cart: [],
        selectedCustomer: null,
        customerSearch: '',
        customerResults: [],
        selectedTerminalId: '{{terminals.0.id|default:""}}',
        selectedTerminal: null,
        paymentMethod: 'CASH',
        discount: 0,
        processing: false,
        showCustomerQuickAdd: false,
        newCustomer: {
            first_name: '',
            last_name: '',
            phone: '',
            email: ''
        },
        
        // Connection status
        isOnline: navigator.onLine,
        
        // Quick access state
        activeTab: 'favorites',
        favoriteProducts: [],
    recentTransactions: [],
    activeCartTab: 'cart',
    activeCategory: 'all',

        // Computed
        get subtotal() {
            return this.cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
        },
        get tax() {
            return this.subtotal * 0.10; // 10% tax
        },
        get total() {
            return this.subtotal + this.tax - this.discount;
        },

        // Initialize
        init() {
            console.log('[POS] Initializing POS system...');
            
            // Load initial data
            if (this.selectedTerminalId) {
                this.loadTerminal();
            }
            
            // Focus on search input
            this.$nextTick(() => {
                const searchInput = document.querySelector('input[type="text"]');
                if (searchInput) searchInput.focus();
            });
            
            // Listen for online/offline events
            window.addEventListener('online', () => {
                this.isOnline = true;
                console.log('[POS] Connection restored');
            });
            
            window.addEventListener('offline', () => {
                this.isOnline = false;
                console.log('[POS] Connection lost');
            });
        },

        async searchProducts() {
            if (!this.searchQuery.trim()) {
                this.searchResults = [];
                return;
            }

            this.loading = true;
            try {
                const response = await fetch(`/api/pos/search/products/?q=${encodeURIComponent(this.searchQuery)}`, {
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.searchResults = data.results || [];
                console.log('[POS] Found products:', this.searchResults.length);
            } catch (error) {
                console.error('[POS] Error searching products:', error);
                this.searchResults = [];
                if (error.message.includes('Failed to fetch')) {
                    alert('Network error. Please check your connection.');
                }
            } finally {
                this.loading = false;
            }
        },

        addToCart(product) {
            // Check if product already in cart
            const existingIndex = this.cart.findIndex(item => item.id === product.id);
            
            if (existingIndex >= 0) {
                // Increment quantity if already in cart
                const newQuantity = this.cart[existingIndex].quantity + 1;
                if (newQuantity <= product.quantity) {
                    this.cart[existingIndex].quantity = newQuantity;
                } else {
                    alert('Insufficient stock');
                }
            } else {
                // Add new item to cart
                this.cart.push({
                    id: product.id,
                    name: product.name,
                    sku: product.sku,
                    unit_price: parseFloat(product.selling_price),
                    quantity: 1,
                    available_quantity: product.quantity
                });
            }

            // Clear search
            this.searchQuery = '';
            this.searchResults = [];
        },

        removeFromCart(index) {
            this.cart.splice(index, 1);
        },

        updateQuantity(index, newQuantity) {
            if (newQuantity < 1) {
                this.removeFromCart(index);
                return;
            }

            if (newQuantity > this.cart[index].available_quantity) {
                alert('Insufficient stock');
                return;
            }

            this.cart[index].quantity = newQuantity;
        },

        clearCart() {
            if (confirm('Are you sure you want to clear the cart?')) {
                this.cart = [];
                this.selectedCustomer = null;
                this.discount = 0;
            }
        },

        async searchCustomers() {
            if (!this.customerSearch.trim()) {
                this.customerResults = [];
                return;
            }

            try {
                const response = await fetch(`/api/pos/search/customers/?q=${encodeURIComponent(this.customerSearch)}`, {
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                this.customerResults = data.results || [];
                console.log('[POS] Found customers:', this.customerResults.length);
            } catch (error) {
                console.error('[POS] Error searching customers:', error);
                this.customerResults = [];
            }
        },

        selectCustomer(customer) {
            this.selectedCustomer = customer;
            this.customerSearch = '';
            this.customerResults = [];
        },

        async quickAddCustomer() {
            try {
                const response = await fetch('/api/pos/customers/quick-add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(this.newCustomer)
                });

                if (response.ok) {
                    const customer = await response.json();
                    this.selectedCustomer = customer;
                    this.showCustomerQuickAdd = false;
                    // Reset form
                    this.newCustomer = {
                        first_name: '',
                        last_name: '',
                        phone: '',
                        email: ''
                    };
                } else {
                    const error = await response.json();
                    alert('Error adding customer: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('Error adding customer:', error);
                alert('Error adding customer');
            }
        },

        loadTerminal() {
            const terminals = [
                {% for terminal in terminals %}
                {
                    id: '{{ terminal.id }}',
                    terminal_id: '{{ terminal.terminal_id }}',
                    branch_name: '{{ terminal.branch.name }}'
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            this.selectedTerminal = terminals.find(t => t.id === this.selectedTerminalId);
        },

        async completeSale() {
            if (this.cart.length === 0) {
                alert('Cart is empty');
                return;
            }

            if (!this.selectedTerminalId) {
                alert('Please select a terminal');
                return;
            }

            this.processing = true;

            try {
                const saleData = {
                    customer_id: this.selectedCustomer?.id || null,
                    terminal_id: this.selectedTerminalId,
                    items: this.cart.map(item => ({
                        inventory_item_id: item.id,
                        quantity: item.quantity,
                        unit_price: item.unit_price.toString()
                    })),
                    payment_method: this.paymentMethod,
                    tax_rate: '10.00',
                    discount: this.discount.toString(),
                    status: 'COMPLETED'
                };

                const response = await fetch('/api/pos/sales/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(saleData)
                });

                if (response.ok) {
                    const sale = await response.json();
                    alert(`Sale completed successfully!\nSale Number: ${sale.sale_number}\nTotal: $${sale.total}`);
                    
                    // Reset cart
                    this.cart = [];
                    this.selectedCustomer = null;
                    this.discount = 0;
                    this.paymentMethod = 'CASH';
                } else {
                    const error = await response.json();
                    alert('Error completing sale: ' + (error.detail || JSON.stringify(error)));
                }
            } catch (error) {
                console.error('Error completing sale:', error);
                alert('Error completing sale. Please try again.');
            } finally {
                this.processing = false;
            }
        },

        async holdSale() {
            alert('Hold sale feature coming soon!');
        },

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
    }
}
</script>

<!-- Main POS Container -->
<div x-data="posApp()" x-init="init()" class="min-h-screen bg-[#f4f1fb] pb-16">
    {% csrf_token %}
    <div class="max-w-[1600px] mx-auto px-8 py-10">
        <div class="flex items-start gap-6">
            <!-- Sidebar -->
            <aside class="w-64 shrink-0 bg-white/90 backdrop-blur border border-purple-100 rounded-3xl shadow-sm p-6 flex flex-col gap-8">
                <div class="flex items-center gap-3 text-purple-600">
                    <div class="flex items-center justify-center w-11 h-11 rounded-2xl bg-purple-100">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.56 5.82 22 7 14.15l-5-4.88 6.91-1.01L12 2z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.3em] text-purple-400">Store</p>
                        <p class="text-lg font-semibold">Jewelry POS</p>
                    </div>
                </div>
                <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400 mb-3">Categories</p>
                    <nav class="space-y-2">
                        <button type="button"
                                @click="activeCategory = 'all'"
                                :class="activeCategory === 'all' ? 'bg-purple-50 text-purple-600 border-purple-200 shadow-sm' : 'text-gray-600 border-transparent hover:border-purple-100 hover:bg-purple-50/60'"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl border transition-all duration-200 font-medium text-sm">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="7" height="7" rx="1.5"></rect>
                                <rect x="14" y="3" width="7" height="7" rx="1.5"></rect>
                                <rect x="3" y="14" width="7" height="7" rx="1.5"></rect>
                                <rect x="14" y="14" width="7" height="7" rx="1.5"></rect>
                            </svg>
                            <span>All Products</span>
                        </button>
                        <button type="button"
                                @click="activeCategory = 'rings'"
                                :class="activeCategory === 'rings' ? 'bg-purple-50 text-purple-600 border-purple-200 shadow-sm' : 'text-gray-600 border-transparent hover:border-purple-100 hover:bg-purple-50/60'"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl border transition-all duration-200 font-medium text-sm">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="13" r="5"></circle>
                                <path d="M9 6l3-4 3 4" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                            <span>Rings</span>
                        </button>
                        <button type="button"
                                @click="activeCategory = 'necklaces'"
                                :class="activeCategory === 'necklaces' ? 'bg-purple-50 text-purple-600 border-purple-200 shadow-sm' : 'text-gray-600 border-transparent hover:border-purple-100 hover:bg-purple-50/60'"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl border transition-all duration-200 font-medium text-sm">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M6 4a6 6 0 0012 0" stroke-linecap="round"></path>
                                <path d="M5 14c0 3.866 3.134 7 7 7s7-3.134 7-7" stroke-linecap="round"></path>
                            </svg>
                            <span>Necklaces</span>
                        </button>
                        <button type="button"
                                @click="activeCategory = 'bracelets'"
                                :class="activeCategory === 'bracelets' ? 'bg-purple-50 text-purple-600 border-purple-200 shadow-sm' : 'text-gray-600 border-transparent hover:border-purple-100 hover:bg-purple-50/60'"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl border transition-all duration-200 font-medium text-sm">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M7 7h10v10H7z" stroke-linejoin="round"></path>
                                <path d="M9 3h6M3 9v6m18-6v6m-6 6H9" stroke-linecap="round"></path>
                            </svg>
                            <span>Bracelets</span>
                        </button>
                        <button type="button"
                                @click="activeCategory = 'earrings'"
                                :class="activeCategory === 'earrings' ? 'bg-purple-50 text-purple-600 border-purple-200 shadow-sm' : 'text-gray-600 border-transparent hover:border-purple-100 hover:bg-purple-50/60'"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl border transition-all duration-200 font-medium text-sm">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 2v6" stroke-linecap="round"></path>
                                <circle cx="12" cy="14" r="4"></circle>
                            </svg>
                            <span>Earrings</span>
                        </button>
                    </nav>
                </div>
                <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400 mb-3">Filters</p>
                    <div class="space-y-4">
                        <div>
                            <p class="text-xs text-gray-400 uppercase tracking-[0.3em] mb-2">Price Range</p>
                            <div class="flex items-center justify-between px-4 py-3 rounded-2xl border border-purple-100 bg-[#f8f5ff] text-sm text-gray-600">
                                <span>$0</span>
                                <div class="h-1 flex-1 mx-3 bg-purple-100 rounded-full">
                                    <div class="h-1 w-2/3 bg-purple-400 rounded-full"></div>
                                </div>
                                <span>$1000+</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 uppercase tracking-[0.3em] mb-2">Material</p>
                            <button type="button" class="w-full flex items-center justify-between px-4 py-3 rounded-2xl border border-purple-100 bg-white text-sm text-gray-600 font-medium hover:border-purple-200 transition">
                                <span>All Materials</span>
                                <svg class="w-4 h-4 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.084l3.71-3.854a.75.75 0 011.08 1.04l-4.24 4.4a.75.75 0 01-1.08 0l-4.24-4.4a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="flex-1 flex items-start gap-6">
                <main class="flex-1 flex flex-col gap-6">
                    <div class="flex flex-wrap items-start justify-between gap-4">
                        <div>
                            <h1 class="text-[34px] leading-tight font-semibold text-gray-900">Transaction Dashboard</h1>
                            <p class="text-gray-500 mt-2">Manage sales and customer transactions efficiently</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 text-sm font-medium text-gray-600">
                                <span :class="isOnline ? 'bg-emerald-500' : 'bg-red-500'" class="w-2.5 h-2.5 rounded-full animate-pulse"></span>
                                <span x-text="isOnline ? 'Online' : 'Offline'"></span>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20H7a2 2 0 01-2-2v-1a5 5 0 015-5h4a5 5 0 015 5v1a2 2 0 01-2 2z" />
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                <span>{{ user.get_full_name|default:user.username }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-purple-100 shadow-sm px-6 py-5">
                        <div class="relative">
                            <svg class="absolute left-5 top-1/2 -translate-y-1/2 w-5 h-5 text-purple-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <input
                                type="text"
                                x-model="searchQuery"
                                @input.debounce.300ms="searchProducts()"
                                @keydown.enter="searchProducts()"
                                placeholder="Search product name, SKU, or scan barcode"
                                class="w-full pl-14 pr-4 py-4 bg-[#f9f6ff] border border-transparent rounded-2xl text-gray-700 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-300 focus:bg-white"
                            >
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-purple-100 shadow-sm overflow-hidden">
                        <div class="px-6 pt-6">
                            <div class="flex items-center gap-6 text-sm font-semibold border-b border-purple-50 pb-4">
                                <button type="button"
                                        @click="activeCartTab = 'cart'"
                                        :class="activeCartTab === 'cart' ? 'text-purple-600 border-purple-500' : 'text-gray-400 border-transparent hover:text-gray-600'"
                                        class="pb-2 border-b-2 transition-all">
                                    Cart (<span x-text="cart.length"></span>)
                                </button>
                                <button type="button"
                                        @click="activeCartTab = 'recent'"
                                        :class="activeCartTab === 'recent' ? 'text-purple-600 border-purple-500' : 'text-gray-400 border-transparent hover:text-gray-600'"
                                        class="pb-2 border-b-2 transition-all">
                                    Recent Items
                                </button>
                            </div>
                        </div>
                        <div class="px-6 py-10" x-show="activeCartTab === 'cart'" x-cloak>
                            <div x-show="cart.length === 0" class="text-center text-gray-500">
                                <div class="mx-auto mb-6 flex h-16 w-16 items-center justify-center rounded-full bg-purple-50 text-purple-300">
                                    <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l1 5m0 0h12l1.2-3.6A1 1 0 0018.2 3H6l1 5zm0 0L5 21h14l-2-12H7z" />
                                    </svg>
                                </div>
                                <p class="text-lg font-semibold text-gray-600">Your cart is empty</p>
                                <p class="text-sm text-gray-400 mt-2">Add products to begin a new sale.</p>
                            </div>
                            <div x-show="cart.length > 0" class="space-y-5">
                                <template x-for="(item, index) in cart" :key="item.id">
                                    <div class="flex items-start justify-between gap-4 rounded-2xl border border-purple-50 bg-white px-5 py-4 shadow-sm">
                                        <div>
                                            <p class="text-base font-semibold text-gray-900" x-text="item.name"></p>
                                            <p class="text-sm text-gray-500 mt-1">SKU: <span x-text="item.sku"></span></p>
                                        </div>
                                        <div class="flex items-center gap-5">
                                            <div class="flex items-center gap-3 rounded-full bg-purple-50 px-3 py-1.5">
                                                <button type="button"
                                                        @click="updateQuantity(index, item.quantity - 1)"
                                                        class="flex h-8 w-8 items-center justify-center rounded-full bg-white text-purple-500 shadow hover:shadow-md transition">
                                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14" />
                                                    </svg>
                                                </button>
                                                <input type="number"
                                                       x-model.number="item.quantity"
                                                       @change="updateQuantity(index, item.quantity)"
                                                       min="1"
                                                       :max="item.available_quantity"
                                                       class="w-16 border-none bg-transparent text-center text-base font-semibold text-gray-700 focus:outline-none"
                                                >
                                                <button type="button"
                                                        @click="updateQuantity(index, item.quantity + 1)"
                                                        class="flex h-8 w-8 items-center justify-center rounded-full bg-purple-500 text-white shadow hover:shadow-md transition">
                                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm text-gray-400">$<span x-text="parseFloat(item.unit_price).toFixed(2)"></span> each</p>
                                                <p class="text-lg font-semibold text-gray-900">$<span x-text="(item.unit_price * item.quantity).toFixed(2)"></span></p>
                                            </div>
                                            <button type="button"
                                                    @click="removeFromCart(index)"
                                                    class="text-gray-300 hover:text-red-500">
                                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="px-6 py-10" x-show="activeCartTab === 'recent'" x-cloak>
                            <p class="text-center text-sm text-gray-400">Recent items will appear here once available.</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-purple-100 shadow-sm px-6 py-6" x-show="searchQuery || loading || searchResults.length > 0" x-cloak>
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xs font-semibold uppercase tracking-[0.4em] text-gray-400">Search Results</h2>
                            <span class="text-xs text-gray-400" x-show="searchResults.length > 0" x-text="`${searchResults.length} items`"></span>
                        </div>
                        <div x-show="loading" class="py-10 text-center">
                            <div class="mx-auto h-10 w-10 animate-spin rounded-full border-4 border-purple-300 border-t-transparent"></div>
                            <p class="mt-3 text-sm text-gray-500">Searching...</p>
                        </div>
                        <div x-show="!loading && searchResults.length === 0 && searchQuery" class="py-12 text-center text-gray-500">
                            <p class="font-medium text-gray-600">No products found</p>
                            <p class="text-sm text-gray-400 mt-1">Try a different search term.</p>
                        </div>
                        <div x-show="!loading && searchResults.length > 0" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
                            <template x-for="product in searchResults" :key="product.id">
                                <button type="button"
                                        @click="addToCart(product)"
                                        class="group text-left rounded-2xl border border-transparent bg-[#f9f6ff] px-4 py-4 shadow-sm transition-all hover:border-purple-200 hover:bg-white">
                                    <div class="flex items-start justify-between gap-3">
                                        <div>
                                            <h3 class="text-base font-semibold text-gray-900 group-hover:text-purple-600" x-text="product.name"></h3>
                                            <p class="text-sm text-gray-500 mt-1">SKU: <span x-text="product.sku"></span></p>
                                            <p class="text-xs text-gray-400 mt-1">
                                                <span x-text="product.karat + 'K'"></span> •
                                                <span x-text="product.weight_grams + 'g'"></span> •
                                                Stock <span x-text="product.quantity"></span>
                                            </p>
                                        </div>
                                        <p class="text-lg font-semibold text-purple-600">$<span x-text="parseFloat(product.selling_price).toFixed(2)"></span></p>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </div>
                </main>

                <!-- Summary Column -->
                <aside class="w-[320px] shrink-0 flex flex-col gap-5">
                    <div class="rounded-3xl border border-purple-100 bg-white p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-[0.3em]">Customer</h2>
                            <button type="button" @click="showCustomerQuickAdd = true" class="flex h-9 w-9 items-center justify-center rounded-2xl bg-purple-500 text-white hover:bg-purple-600 transition">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14" />
                                </svg>
                            </button>
                        </div>
                        <div class="relative">
                            <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-purple-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <input type="text"
                                   x-model="customerSearch"
                                   @input.debounce.300ms="searchCustomers()"
                                   placeholder="Search customer..."
                                   class="w-full rounded-2xl border border-transparent bg-[#f9f6ff] py-3 pl-12 pr-4 text-sm text-gray-700 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-300 focus:bg-white">
                        </div>
                        <div x-show="customerResults.length > 0" x-cloak class="mt-3 max-h-40 overflow-y-auto rounded-2xl border border-purple-100 bg-white shadow-lg">
                            <template x-for="customer in customerResults" :key="customer.id">
                                <button type="button"
                                        @click="selectCustomer(customer)"
                                        class="w-full px-4 py-3 text-left text-sm text-gray-600 hover:bg-purple-50">
                                    <p class="font-semibold text-gray-800" x-text="customer.full_name"></p>
                                    <p class="text-xs text-gray-400" x-text="customer.phone"></p>
                                </button>
                            </template>
                        </div>
                        <div x-show="selectedCustomer" x-cloak class="mt-3 flex items-center justify-between rounded-2xl border border-purple-100 bg-purple-50 px-4 py-3">
                            <div>
                                <p class="text-sm font-semibold text-gray-700" x-text="selectedCustomer?.full_name"></p>
                                <p class="text-xs text-gray-500" x-text="selectedCustomer?.phone"></p>
                            </div>
                            <button type="button" @click="selectedCustomer = null; customerSearch = ''" class="text-gray-400 hover:text-red-500">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="rounded-3xl border border-purple-100 bg-white p-6 shadow-sm">
                        <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-[0.3em] mb-4">Terminal</h2>
                        <select x-model="selectedTerminalId"
                                @change="loadTerminal()"
                                class="w-full rounded-2xl border border-transparent bg-[#f9f6ff] px-4 py-3 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-300 focus:bg-white">
                            <option value="">Select Terminal</option>
                            {% for terminal in terminals %}
                            <option value="{{ terminal.id }}">{{ terminal.terminal_id }} - {{ terminal.branch.name }}</option>
                            {% endfor %}
                        </select>
                        <p class="mt-3 text-xs uppercase tracking-[0.3em] text-gray-400">Current</p>
                        <p class="text-sm font-semibold text-gray-700 mt-1" x-text="selectedTerminal ? selectedTerminal.terminal_id : 'Not selected'"></p>
                    </div>

                    <div class="rounded-3xl border border-purple-100 bg-white p-6 shadow-sm">
                        <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-[0.3em] mb-4">Payment</h2>
                        <div class="flex flex-wrap gap-3">
                            <button type="button"
                                    @click="paymentMethod = 'CASH'"
                                    :class="paymentMethod === 'CASH' ? 'bg-purple-500 text-white shadow-sm border-purple-500' : 'bg-[#f9f6ff] text-gray-600 border-transparent hover:border-purple-200'"
                                    class="flex-1 rounded-2xl border px-4 py-3 text-sm font-semibold transition-all">
                                Cash
                            </button>
                            <button type="button"
                                    @click="paymentMethod = 'CARD'"
                                    :class="paymentMethod === 'CARD' ? 'bg-purple-500 text-white shadow-sm border-purple-500' : 'bg-[#f9f6ff] text-gray-600 border-transparent hover:border-purple-200'"
                                    class="flex-1 rounded-2xl border px-4 py-3 text-sm font-semibold transition-all">
                                Card
                            </button>
                            <button type="button"
                                    @click="paymentMethod = 'STORE_CREDIT'"
                                    :class="paymentMethod === 'STORE_CREDIT' ? 'bg-purple-500 text-white shadow-sm border-purple-500' : 'bg-[#f9f6ff] text-gray-600 border-transparent hover:border-purple-200'"
                                    class="flex-1 rounded-2xl border px-4 py-3 text-sm font-semibold transition-all">
                                Store Credit
                            </button>
                        </div>
                    </div>

                    <div class="rounded-3xl border border-purple-100 bg-white p-6 shadow-sm space-y-4">
                        <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-[0.3em]">Order Summary</h2>
                        <div class="space-y-3 text-sm text-gray-500">
                            <div class="flex items-center justify-between">
                                <span>Subtotal</span>
                                <span class="font-semibold text-gray-800">$<span x-text="subtotal.toFixed(2)"></span></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span>Tax (10%)</span>
                                <span class="font-semibold text-gray-800">$<span x-text="tax.toFixed(2)"></span></span>
                            </div>
                            <div class="flex items-center justify-between gap-3">
                                <span>Discount</span>
                                <input type="number"
                                       x-model.number="discount"
                                       min="0"
                                       :max="subtotal"
                                       step="0.01"
                                       placeholder="0.00"
                                       class="w-28 rounded-2xl border border-transparent bg-[#f9f6ff] px-3 py-2 text-right text-sm font-semibold text-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-300 focus:bg-white">
                            </div>
                        </div>
                        <div class="flex items-center justify-between border-t border-purple-100 pt-4">
                            <span class="text-base font-semibold text-gray-500">Total</span>
                            <span class="text-2xl font-semibold text-gray-900">$<span x-text="total.toFixed(2)"></span></span>
                        </div>
                        <div class="grid gap-3 pt-2">
                            <button type="button"
                                    @click="holdSale()"
                                    :disabled="cart.length === 0"
                                    class="flex items-center justify-center gap-3 rounded-2xl border border-transparent bg-[#ebe4ff] px-4 py-3 text-sm font-semibold text-purple-700 transition disabled:cursor-not-allowed disabled:opacity-50">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l3 3" />
                                </svg>
                                Hold Sale
                            </button>
                            <button type="button"
                                    @click="completeSale()"
                                    :disabled="cart.length === 0 || !selectedTerminalId || processing"
                                    class="flex items-center justify-center gap-3 rounded-2xl bg-green-500 px-4 py-3 text-sm font-semibold text-white transition hover:bg-green-600 disabled:cursor-not-allowed disabled:bg-gray-300">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                </svg>
                                <span x-text="processing ? 'Processing...' : 'Complete Sale'"></span>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs font-semibold text-gray-500">
                            <button type="button" class="rounded-2xl border border-purple-100 bg-white px-3 py-3 text-left hover:border-purple-200 transition">Reprint Receipt</button>
                            <button type="button" class="rounded-2xl border border-purple-100 bg-white px-3 py-3 text-left hover:border-purple-200 transition">Held Sales</button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</div>

<style>
[x-cloak] {
    display: none !important;
}
</style>
{% endblock %}
