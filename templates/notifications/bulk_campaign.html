{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Bulk Campaign" %}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="max-w-4xl mx-auto">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                {{ page_title }}
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">
                {% trans "Send targeted email or SMS campaigns to customer segments." %}
            </p>
        </div>

        <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
            <form id="campaignForm" class="p-6">
                {% csrf_token %}
                
                <!-- Campaign Type -->
                <div class="mb-6">
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        {% trans "Campaign Type" %}
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="campaign_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {% trans "Type" %} *
                            </label>
                            <select id="campaign_type" name="campaign_type" required
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                                    onchange="toggleCampaignType()">
                                {% for value, label in campaign_types %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label for="segment_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {% trans "Target Segment" %} *
                            </label>
                            <select id="segment_id" name="segment_id" required
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                <option value="">{% trans "Select a segment..." %}</option>
                                {% for segment in segments %}
                                <option value="{{ segment.id }}">{{ segment.name }} ({{ segment.customer_count }} customers)</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Email Campaign Settings -->
                <div id="emailSettings" class="mb-6">
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        {% trans "Email Settings" %}
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="email_template" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {% trans "Email Template" %} *
                            </label>
                            <select id="email_template" name="template_name"
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                                <option value="">{% trans "Select template..." %}</option>
                                {% for template in email_templates %}
                                <option value="{{ template.name }}">{{ template.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label for="subject" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {% trans "Email Subject" %} *
                            </label>
                            <input type="text" id="subject" name="subject"
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                </div>

                <!-- SMS Campaign Settings -->
                <div id="smsSettings" class="mb-6 hidden">
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        {% trans "SMS Settings" %}
                    </h2>
                    
                    <div>
                        <label for="sms_template" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {% trans "SMS Template" %} *
                        </label>
                        <select id="sms_template" name="sms_template_name"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">{% trans "Select template..." %}</option>
                            {% for template in sms_templates %}
                            <option value="{{ template.name }}">{{ template.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Template Variables -->
                <div class="mb-6">
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        {% trans "Template Variables" %}
                    </h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        {% trans "Add custom variables to personalize your campaign. Use these in your templates as {{ variable_name }}." %}
                    </p>
                    
                    <div id="templateVariables" class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <input type="text" placeholder="Variable name" 
                                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                            <input type="text" placeholder="Variable value" 
                                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                            <button type="button" onclick="removeVariable(this)" 
                                    class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                                {% trans "Remove" %}
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" onclick="addVariable()" 
                            class="mt-3 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                        + {% trans "Add Variable" %}
                    </button>
                </div>

                <!-- Campaign Preview -->
                <div class="mb-6">
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        {% trans "Campaign Summary" %}
                    </h2>
                    
                    <div id="campaignSummary" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <p class="text-gray-500 dark:text-gray-400">
                            {% trans "Select a segment and template to see campaign summary." %}
                        </p>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4">
                    <a href="{% url 'notifications:segments' %}" 
                       class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600">
                        {% trans "Cancel" %}
                    </a>
                    <button type="button" onclick="previewCampaign()" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                        {% trans "Preview" %}
                    </button>
                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        {% trans "Send Campaign" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleCampaignType() {
    const campaignType = document.getElementById('campaign_type').value;
    const emailSettings = document.getElementById('emailSettings');
    const smsSettings = document.getElementById('smsSettings');
    
    if (campaignType === 'EMAIL') {
        emailSettings.classList.remove('hidden');
        smsSettings.classList.add('hidden');
        document.getElementById('email_template').required = true;
        document.getElementById('subject').required = true;
        document.getElementById('sms_template').required = false;
    } else {
        emailSettings.classList.add('hidden');
        smsSettings.classList.remove('hidden');
        document.getElementById('email_template').required = false;
        document.getElementById('subject').required = false;
        document.getElementById('sms_template').required = true;
    }
}

function addVariable() {
    const container = document.getElementById('templateVariables');
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-3';
    div.innerHTML = `
        <input type="text" placeholder="Variable name" 
               class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
        <input type="text" placeholder="Variable value" 
               class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
        <button type="button" onclick="removeVariable(this)" 
                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
            {% trans "Remove" %}
        </button>
    `;
    container.appendChild(div);
}

function removeVariable(button) {
    button.parentElement.remove();
}

function previewCampaign() {
    updateCampaignSummary();
}

function updateCampaignSummary() {
    const segmentSelect = document.getElementById('segment_id');
    const campaignType = document.getElementById('campaign_type').value;
    const selectedSegment = segmentSelect.options[segmentSelect.selectedIndex];
    
    if (selectedSegment.value) {
        const segmentText = selectedSegment.text;
        const summary = `
            <div class="space-y-2">
                <p><strong>{% trans "Type:" %}</strong> ${campaignType}</p>
                <p><strong>{% trans "Target:" %}</strong> ${segmentText}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    {% trans "Ready to send campaign to selected segment." %}
                </p>
            </div>
        `;
        document.getElementById('campaignSummary').innerHTML = summary;
    }
}

document.getElementById('campaignForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!confirm('{% trans "Are you sure you want to send this campaign? This action cannot be undone." %}')) {
        return;
    }
    
    const formData = new FormData();
    
    // Add basic form fields
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('segment_id', document.getElementById('segment_id').value);
    formData.append('campaign_type', document.getElementById('campaign_type').value);
    
    // Add template name based on campaign type
    const campaignType = document.getElementById('campaign_type').value;
    if (campaignType === 'EMAIL') {
        formData.append('template_name', document.getElementById('email_template').value);
        formData.append('subject', document.getElementById('subject').value);
    } else {
        formData.append('template_name', document.getElementById('sms_template').value);
    }
    
    // Add template variables
    const variableRows = document.querySelectorAll('#templateVariables > div');
    variableRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs[0].value && inputs[1].value) {
            formData.append(`context_${inputs[0].value}`, inputs[1].value);
        }
    });
    
    fetch('{% url "notifications:bulk_campaign" %}', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = '{% url "notifications:campaign_analytics" %}';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
});

// Initialize form
toggleCampaignType();

// Update summary when segment changes
document.getElementById('segment_id').addEventListener('change', updateCampaignSummary);
</script>
{% endblock %}