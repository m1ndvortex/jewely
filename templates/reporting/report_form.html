{% extends "base.html" %}
{% load i18n %}

{% block title %}
    {% if form.instance.pk %}{% trans "Edit Report" %}{% else %}{% trans "Create Report" %}{% endif %}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-6">
        <a href="{% if form.instance.pk %}{% url 'reporting:report_detail' form.instance.pk %}{% else %}{% url 'reporting:report_list' %}{% endif %}" 
           class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
            {% if form.instance.pk %}
                {% trans "Edit Report" %}
            {% else %}
                {% trans "Create New Report" %}
            {% endif %}
        </h1>
    </div>

    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        {% if form.errors %}
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-red-600 dark:text-red-400 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="flex-1">
                        <h3 class="text-sm font-medium text-red-800 dark:text-red-400">{% trans "Please correct the following errors:" %}</h3>
                        <ul class="mt-2 text-sm text-red-700 dark:text-red-300 list-disc list-inside">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ field|title }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Basic Information -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">{% trans "Basic Information" %}</h2>
            
            <div class="space-y-4">
                <!-- Name -->
                <div>
                    <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        {% trans "Report Name" %} <span class="text-red-600">*</span>
                    </label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.name.errors.0 }}</p>
                    {% endif %}
                    {% if form.name.help_text %}
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.name.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Description -->
                <div>
                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        {% trans "Description" %}
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.description.errors.0 }}</p>
                    {% endif %}
                    {% if form.description.help_text %}
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.description.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Category -->
                <div>
                    <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        {% trans "Category" %} <span class="text-red-600">*</span>
                    </label>
                    {{ form.category }}
                    {% if form.category.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.category.errors.0 }}</p>
                    {% endif %}
                    {% if form.category.help_text %}
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.category.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Output Formats -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {% trans "Output Formats" %} <span class="text-red-600">*</span>
                    </label>
                    {{ form.output_formats }}
                    {% if form.output_formats.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.output_formats.errors.0 }}</p>
                    {% endif %}
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        {% trans "Select one or more output formats for this report" %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Query Configuration -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">{% trans "Query Configuration" %}</h2>
            
            <div class="space-y-4">
                <div>
                    <label for="{{ form.query_config.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        {% trans "Query Configuration (JSON)" %} <span class="text-red-600">*</span>
                    </label>
                    <div class="relative">
                        {{ form.query_config }}
                        <div class="absolute top-2 right-2">
                            <button type="button" onclick="formatJSON('{{ form.query_config.id_for_label }}')" 
                                    class="px-3 py-1 bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 text-xs rounded hover:bg-gray-200 dark:hover:bg-gray-500">
                                {% trans "Format" %}
                            </button>
                        </div>
                    </div>
                    {% if form.query_config.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.query_config.errors.0 }}</p>
                    {% endif %}
                    <div class="mt-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded p-3">
                        <p class="text-xs text-blue-800 dark:text-blue-300 font-medium mb-2">{% trans "Example Configuration:" %}</p>
                        <pre class="text-xs text-blue-700 dark:text-blue-400 overflow-x-auto"><code>{
  "query_type": "sql",
  "sql": "SELECT * FROM sales WHERE date >= :start_date AND date <= :end_date",
  "aggregations": ["SUM(total)", "COUNT(*)"],
  "group_by": ["category"],
  "filters": {
    "start_date": "2024-01-01",
    "end_date": "2024-12-31"
  }
}</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parameters -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">{% trans "Report Parameters" %}</h2>
            
            <div class="space-y-4">
                <div>
                    <label for="{{ form.parameters.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        {% trans "Parameters (JSON)" %}
                    </label>
                    {{ form.parameters }}
                    {% if form.parameters.errors %}
                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.parameters.errors.0 }}</p>
                    {% endif %}
                    <div class="mt-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded p-3">
                        <p class="text-xs text-blue-800 dark:text-blue-300 font-medium mb-2">{% trans "Example Parameters:" %}</p>
                        <pre class="text-xs text-blue-700 dark:text-blue-400 overflow-x-auto"><code>{
  "start_date": {
    "label": "Start Date",
    "type": "date",
    "required": true,
    "default": "2024-01-01"
  },
  "end_date": {
    "label": "End Date",
    "type": "date",
    "required": true,
    "default": "2024-12-31"
  },
  "category": {
    "label": "Category",
    "type": "select",
    "options": ["All", "Rings", "Necklaces"],
    "default": "All"
  }
}</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-between items-center pt-6 border-t border-gray-200 dark:border-gray-700">
            <a href="{% if form.instance.pk %}{% url 'reporting:report_detail' form.instance.pk %}{% else %}{% url 'reporting:report_list' %}{% endif %}" 
               class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition">
                {% trans "Cancel" %}
            </a>
            <div class="flex gap-3">
                <button type="submit" name="action" value="save_and_continue"
                        class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                    {% trans "Save & Continue Editing" %}
                </button>
                <button type="submit" name="action" value="save"
                        class="inline-flex items-center px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    {% if form.instance.pk %}
                        {% trans "Update Report" %}
                    {% else %}
                        {% trans "Create Report" %}
                    {% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function formatJSON(fieldId) {
    const textarea = document.getElementById(fieldId);
    if (!textarea) return;
    
    try {
        const json = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(json, null, 2);
    } catch (e) {
        alert('{% trans "Invalid JSON format" %}');
    }
}

// Auto-save draft to localStorage
let autoSaveTimer;
const formFields = ['{{ form.name.id_for_label }}', '{{ form.description.id_for_label }}', '{{ form.query_config.id_for_label }}', '{{ form.parameters.id_for_label }}'];

formFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
        field.addEventListener('input', () => {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                localStorage.setItem('report_draft_' + fieldId, field.value);
            }, 1000);
        });
        
        // Load draft on page load (only for new reports)
        {% if not form.instance.pk %}
        const draft = localStorage.getItem('report_draft_' + fieldId);
        if (draft && !field.value) {
            field.value = draft;
        }
        {% endif %}
    }
});

// Clear drafts on successful submit
document.querySelector('form').addEventListener('submit', () => {
    formFields.forEach(fieldId => {
        localStorage.removeItem('report_draft_' + fieldId);
    });
});
</script>
{% endblock %}
